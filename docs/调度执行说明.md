# è°ƒåº¦æ‰§è¡Œè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿæ”¯æŒçµæ´»çš„ä»»åŠ¡è°ƒåº¦åŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ç…§ä¸åŒçš„æ—¶é—´ç­–ç•¥è‡ªåŠ¨æ‰§è¡Œçˆ¬è™«ä»»åŠ¡ã€‚è°ƒåº¦ç³»ç»ŸåŸºäº Celery Beat å®ç°ï¼Œæ”¯æŒç«‹å³æ‰§è¡Œã€å®šæ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œç­‰å¤šç§æ¨¡å¼ã€‚

## ğŸ¯ è°ƒåº¦ç±»å‹

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹ 4 ç§è°ƒåº¦ç±»å‹ï¼š

| è°ƒåº¦ç±»å‹ | æšä¸¾å€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|--------|------|---------|
| **ç«‹å³æ‰§è¡Œ** | `immediate` | åˆ›å»ºåç«‹å³æ‰§è¡Œ | ä¸´æ—¶æµ‹è¯•ã€æ‰‹åŠ¨è§¦å‘ |
| **å®šæ—¶æ‰§è¡Œ** | `scheduled` | æŒ‡å®šæ—¶é—´æ‰§è¡Œä¸€æ¬¡ | ç‰¹å®šæ—¶é—´ç‚¹çš„ä»»åŠ¡ |
| **å‘¨è°ƒåº¦** | `weekly` | æ¯å‘¨å›ºå®šæ—¶é—´æ‰§è¡Œ | å‘¨æŠ¥ã€å‘¨æœŸæ€§æ•°æ®é‡‡é›† |
| **æœˆè°ƒåº¦** | `monthly` | æ¯æœˆå›ºå®šæ—¥æœŸæ‰§è¡Œ | æœˆæŠ¥ã€è´¦å•æ•°æ®é‡‡é›† |

---

## ğŸ”§ è°ƒåº¦é…ç½®è¯´æ˜

### 1. ç«‹å³æ‰§è¡Œ (immediate)

**é…ç½®æ ¼å¼**ï¼š
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "schedule_type": "immediate",
  "schedule_config": {}
}
```

**è¯´æ˜**ï¼š
- æ— éœ€é…ç½®å‚æ•°
- åˆ›å»ºåç«‹å³æ‰§è¡Œ
- é€‚åˆä¸´æ—¶æµ‹è¯•å’Œæ‰‹åŠ¨è§¦å‘

---

### 2. å®šæ—¶æ‰§è¡Œ (scheduled)

**é…ç½®æ ¼å¼**ï¼š
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "schedule_type": "scheduled",
  "schedule_config": {
    "datetime": "2025-10-15 14:30:00"
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `datetime`: æŒ‡å®šçš„æ‰§è¡Œæ—¶é—´ï¼ˆæ ¼å¼ï¼š`YYYY-MM-DD HH:MM:SS`ï¼‰

**ç‰¹ç‚¹**ï¼š
- ä¸€æ¬¡æ€§æ‰§è¡Œ
- æ‰§è¡Œåè‡ªåŠ¨ç¦ç”¨
- é€‚åˆç‰¹å®šæ—¶é—´ç‚¹çš„ä»»åŠ¡

**ç¤ºä¾‹**ï¼š
```bash
# åœ¨ 2025å¹´10æœˆ15æ—¥ ä¸‹åˆ2ç‚¹30åˆ† æ‰§è¡Œä¸€æ¬¡
{
  "datetime": "2025-10-15 14:30:00"
}
```

---

### 3. å‘¨è°ƒåº¦ (weekly)

**é…ç½®æ ¼å¼**ï¼š
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 3, 5],
    "time": "09:00:00"
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `days`: ä¸€å‘¨ä¸­çš„å“ªå‡ å¤©æ‰§è¡Œï¼ˆ1=å‘¨ä¸€ï¼Œ2=å‘¨äºŒï¼Œ...ï¼Œ7=å‘¨æ—¥ï¼‰
- `time`: æ¯å¤©çš„æ‰§è¡Œæ—¶é—´ï¼ˆæ ¼å¼ï¼š`HH:MM:SS`ï¼‰

**ç‰¹ç‚¹**ï¼š
- å‘¨æœŸæ€§é‡å¤æ‰§è¡Œ
- æ”¯æŒå¤šå¤©é…ç½®
- è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´

**ç¤ºä¾‹**ï¼š
```bash
# æ¯å‘¨ä¸€ã€ä¸‰ã€äº”æ—©ä¸Š9ç‚¹æ‰§è¡Œ
{
  "days": [1, 3, 5],
  "time": "09:00:00"
}

# æ¯å‘¨æœ«ï¼ˆå‘¨å…­ã€å‘¨æ—¥ï¼‰ä¸‹åˆ5ç‚¹æ‰§è¡Œ
{
  "days": [6, 7],
  "time": "17:00:00"
}
```

---

### 4. æœˆè°ƒåº¦ (monthly)

**é…ç½®æ ¼å¼**ï¼š
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1, 15],
    "time": "10:00:00"
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `dates`: æ¯æœˆçš„å“ªå‡ å·æ‰§è¡Œï¼ˆ1-31ï¼‰
- `time`: æ¯å¤©çš„æ‰§è¡Œæ—¶é—´ï¼ˆæ ¼å¼ï¼š`HH:MM:SS`ï¼‰

**ç‰¹ç‚¹**ï¼š
- æŒ‰æœˆé‡å¤æ‰§è¡Œ
- æ”¯æŒå¤šä¸ªæ—¥æœŸ
- è‡ªåŠ¨å¤„ç†ä¸å­˜åœ¨çš„æ—¥æœŸï¼ˆå¦‚2æœˆ30æ—¥ï¼‰

**ç¤ºä¾‹**ï¼š
```bash
# æ¯æœˆ1å·å’Œ15å·æ—©ä¸Š10ç‚¹æ‰§è¡Œ
{
  "dates": [1, 15],
  "time": "10:00:00"
}

# æ¯æœˆæœ€åä¸€å¤©ä¸‹åˆ6ç‚¹æ‰§è¡Œ
{
  "dates": [31],
  "time": "18:00:00"
}
```

---

## ğŸš€ API æ¥å£è¯´æ˜

### 1. åˆ›å»ºè°ƒåº¦

**æ¥å£**: `POST /api/v1/scheduler/`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 3, 5],
    "time": "09:00:00"
  }
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "message": "è°ƒåº¦åˆ›å»ºæˆåŠŸ",
  "data": {
    "schedule_id": "a472132c-130a-456a-b05f-c5ebf36d5418"
  }
}
```

**cURL ç¤ºä¾‹**ï¼š
```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "550e8400-e29b-41d4-a716-446655440000",
    "schedule_type": "weekly",
    "schedule_config": {
      "days": [1, 3, 5],
      "time": "09:00:00"
    }
  }'
```

---

### 2. æŸ¥è¯¢ä»»åŠ¡çš„è°ƒåº¦é…ç½®

**æ¥å£**: `GET /api/v1/scheduler/task/{task_id}`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {access_token}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "message": "success",
  "data": [
    {
      "id": "a472132c-130a-456a-b05f-c5ebf36d5418",
      "task_id": "550e8400-e29b-41d4-a716-446655440000",
      "schedule_type": "weekly",
      "schedule_config": {
        "days": [1, 3, 5],
        "time": "09:00:00"
      },
      "is_active": true,
      "next_run_time": "2025-10-13T09:00:00",
      "create_time": "2025-10-09T10:30:00"
    }
  ]
}
```

**cURL ç¤ºä¾‹**ï¼š
```bash
curl -X GET "http://localhost:8089/api/v1/scheduler/task/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

### 3. å¯ç”¨/ç¦ç”¨è°ƒåº¦

**æ¥å£**: `PUT /api/v1/scheduler/{schedule_id}/toggle`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {access_token}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "message": "è°ƒåº¦å¯ç”¨æˆåŠŸ"
}
```

**cURL ç¤ºä¾‹**ï¼š
```bash
# åˆ‡æ¢è°ƒåº¦çŠ¶æ€ï¼ˆå¯ç”¨ â†” ç¦ç”¨ï¼‰
curl -X PUT "http://localhost:8089/api/v1/scheduler/a472132c-130a-456a-b05f-c5ebf36d5418/toggle" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

### 4. åˆ é™¤è°ƒåº¦

**æ¥å£**: `DELETE /api/v1/scheduler/{schedule_id}`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {access_token}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "message": "è°ƒåº¦åˆ é™¤æˆåŠŸ"
}
```

**cURL ç¤ºä¾‹**ï¼š
```bash
curl -X DELETE "http://localhost:8089/api/v1/scheduler/a472132c-130a-456a-b05f-c5ebf36d5418" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## âš™ï¸ è°ƒåº¦æ‰§è¡Œæœºåˆ¶

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è°ƒåº¦æ‰§è¡Œæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·åˆ›å»ºè°ƒåº¦
   POST /api/v1/scheduler/
   â†“
   â”œâ”€ éªŒè¯ä»»åŠ¡å­˜åœ¨
   â”œâ”€ éªŒè¯æƒé™
   â”œâ”€ æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒè°ƒåº¦
   â””â”€ è®¡ç®— next_run_time

2. ä¿å­˜åˆ°æ•°æ®åº“
   task_schedules è¡¨
   â†“
   â”œâ”€ task_id
   â”œâ”€ schedule_type
   â”œâ”€ schedule_config
   â”œâ”€ next_run_time  â† å…³é”®å­—æ®µ
   â””â”€ is_active

3. Celery Beat å®šæ—¶æ£€æŸ¥
   æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
   â†“
   SELECT * FROM task_schedules
   WHERE is_active = TRUE
   AND next_run_time <= NOW()

4. æ‰§è¡Œåˆ°æœŸä»»åŠ¡
   â†“
   â”œâ”€ æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
   â”œâ”€ åˆ›å»º TaskExecution è®°å½•
   â”œâ”€ æäº¤åˆ° Celery é˜Ÿåˆ—
   â””â”€ æ›´æ–° next_run_time

5. å¯åŠ¨ Docker å®¹å™¨
   execute_data_collection_task
   â†“
   æ‰§è¡Œçˆ¬è™«ä»»åŠ¡
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | è¯´æ˜ | æ–‡ä»¶ä½ç½® |
|------|------|---------|
| **Celery Beat** | å®šæ—¶è°ƒåº¦å™¨ï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ | `src/worker/celeryconfig.py` |
| **process_scheduled_tasks** | å¤„ç†åˆ°æœŸçš„è°ƒåº¦ä»»åŠ¡ | `src/worker/scheduler_tasks.py` |
| **ScheduleUtils** | è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ | `src/utils/schedule_utils.py` |
| **TaskSchedule** | è°ƒåº¦é…ç½®æ•°æ®æ¨¡å‹ | `src/data_platform_api/models/task.py` |

### Celery Beat é…ç½®

```python
# src/worker/celeryconfig.py
beat_schedule = {
    'process-scheduled-tasks': {
        'task': 'process_scheduled_tasks',
        'schedule': crontab(minute='*'),  # æ¯åˆ†é’Ÿæ‰§è¡Œ
        'options': {'queue': 'scheduler'}
    }
}
```

### ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è®¡ç®—

ç³»ç»Ÿä¼šæ ¹æ®è°ƒåº¦ç±»å‹è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ï¼š

**å‘¨è°ƒåº¦ç¤ºä¾‹**ï¼š
```python
# å½“å‰æ—¶é—´ï¼š2025-10-09 å‘¨ä¸‰ 10:00
# é…ç½®ï¼šæ¯å‘¨ä¸€ã€ä¸‰ã€äº” 09:00
# è®¡ç®—ç»“æœï¼š2025-10-11 å‘¨äº” 09:00
```

**æœˆè°ƒåº¦ç¤ºä¾‹**ï¼š
```python
# å½“å‰æ—¶é—´ï¼š2025-10-09
# é…ç½®ï¼šæ¯æœˆ1å·å’Œ15å· 10:00
# è®¡ç®—ç»“æœï¼š2025-10-15 10:00
```

---

## ğŸ”’ æƒé™æ§åˆ¶

### æƒé™è§„åˆ™

1. **åˆ›å»ºè°ƒåº¦**ï¼š
   - ç®¡ç†å‘˜å¯ä»¥ä¸ºä»»ä½•ä»»åŠ¡åˆ›å»ºè°ƒåº¦
   - æ™®é€šç”¨æˆ·åªèƒ½ä¸ºè‡ªå·±åˆ›å»ºçš„ä»»åŠ¡åˆ›å»ºè°ƒåº¦

2. **æŸ¥è¯¢è°ƒåº¦**ï¼š
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è°ƒåº¦
   - æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±ä»»åŠ¡çš„è°ƒåº¦

3. **ä¿®æ”¹/åˆ é™¤è°ƒåº¦**ï¼š
   - ç®¡ç†å‘˜å¯ä»¥æ“ä½œæ‰€æœ‰è°ƒåº¦
   - æ™®é€šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±ä»»åŠ¡çš„è°ƒåº¦

### éªŒè¯é€»è¾‘

```python
# æ£€æŸ¥ä»»åŠ¡æƒé™
if not current_user.is_admin and task.creator_id != current_user.id:
    raise HTTPException(status_code=403, detail="æ— æƒè°ƒåº¦æ­¤ä»»åŠ¡")
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ¯æ—¥æ•°æ®é‡‡é›†

**éœ€æ±‚**ï¼šæ¯å¤©æ—©ä¸Š 8 ç‚¹é‡‡é›†ç”µå•†ç½‘ç«™çš„å•†å“æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å‘¨è°ƒåº¦ï¼Œè®¾ç½®æ¯å¤©æ‰§è¡Œ
```json
{
  "task_id": "your-task-id",
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 2, 3, 4, 5, 6, 7],
    "time": "08:00:00"
  }
}
```

---

### åœºæ™¯ 2ï¼šå·¥ä½œæ—¥æ•°æ®é‡‡é›†

**éœ€æ±‚**ï¼šæ¯ä¸ªå·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰ä¸‹åˆ 6 ç‚¹é‡‡é›†æ–°é—»æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å‘¨è°ƒåº¦ï¼Œåªè®¾ç½®å·¥ä½œæ—¥
```json
{
  "task_id": "your-task-id",
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 2, 3, 4, 5],
    "time": "18:00:00"
  }
}
```

---

### åœºæ™¯ 3ï¼šæœˆåº¦æŠ¥è¡¨

**éœ€æ±‚**ï¼šæ¯æœˆ1å·å‡Œæ™¨ 2 ç‚¹ç”Ÿæˆä¸Šæœˆæ•°æ®æŠ¥è¡¨

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æœˆè°ƒåº¦
```json
{
  "task_id": "your-task-id",
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1],
    "time": "02:00:00"
  }
}
```

---

### åœºæ™¯ 4ï¼šåŒå‘¨æŠ¥è¡¨

**éœ€æ±‚**ï¼šæ¯æœˆ 1 å·å’Œ 15 å·ç”ŸæˆæŠ¥è¡¨

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æœˆè°ƒåº¦ï¼Œè®¾ç½®ä¸¤ä¸ªæ—¥æœŸ
```json
{
  "task_id": "your-task-id",
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1, 15],
    "time": "00:00:00"
  }
}
```

---

### åœºæ™¯ 5ï¼šä¸€æ¬¡æ€§ä»»åŠ¡

**éœ€æ±‚**ï¼šåœ¨ä¿ƒé”€æ´»åŠ¨å¼€å§‹æ—¶ï¼ˆ2025-11-11 00:00ï¼‰é‡‡é›†æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å®šæ—¶æ‰§è¡Œ
```json
{
  "task_id": "your-task-id",
  "schedule_type": "scheduled",
  "schedule_config": {
    "datetime": "2025-11-11 00:00:00"
  }
}
```

---

## ğŸ› ï¸ å¯åŠ¨è°ƒåº¦æœåŠ¡

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ PDM

```bash
# 1. å¯åŠ¨ FastAPI æœåŠ¡
pdm run start

# 2. å¯åŠ¨ Celery Workerï¼ˆæ‰§è¡Œä»»åŠ¡ï¼‰
pdm run worker

# 3. å¯åŠ¨ Celery Beatï¼ˆå®šæ—¶è°ƒåº¦å™¨ï¼‰
pdm run beat

# 4. ï¼ˆå¯é€‰ï¼‰å¯åŠ¨ Flower ç›‘æ§ç•Œé¢
pdm run flower
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Docker Compose

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker/docker-compose.yml up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker/docker-compose.yml logs -f
```

### æ–¹å¼ä¸‰ï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
# 1. å¯åŠ¨ API æœåŠ¡
uvicorn src.main:app --host 0.0.0.0 --port 8089 --reload

# 2. å¯åŠ¨ Worker
celery -A src.worker.main worker \
  -Q task_execution,docker_management,monitoring,scheduler,cleanup,health_check \
  -l info --concurrency=4

# 3. å¯åŠ¨ Beat
celery -A src.worker.main beat --loglevel=info

# 4. å¯åŠ¨ Flower
celery -A src.worker.main flower --port=5555 --basic_auth=admin:admin123
```

### éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥ API æœåŠ¡
curl http://localhost:8089/api/v1/

# æ£€æŸ¥ Celery Worker
celery -A src.worker.main inspect active

# æ£€æŸ¥ Celery Beat
celery -A src.worker.main inspect scheduled

# è®¿é—® Flower ç›‘æ§
open http://localhost:5555
```

---

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹è°ƒåº¦çŠ¶æ€

```sql
-- æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒçš„è°ƒåº¦
SELECT 
  ts.id,
  t.task_name,
  ts.schedule_type,
  ts.next_run_time,
  ts.is_active
FROM task_schedules ts
JOIN tasks t ON ts.task_id = t.id
WHERE ts.is_active = TRUE
ORDER BY ts.next_run_time;

-- æŸ¥çœ‹å³å°†æ‰§è¡Œçš„è°ƒåº¦ï¼ˆæœªæ¥1å°æ—¶å†…ï¼‰
SELECT 
  ts.id,
  t.task_name,
  ts.schedule_type,
  ts.next_run_time,
  TIMESTAMPDIFF(MINUTE, NOW(), ts.next_run_time) AS minutes_until_run
FROM task_schedules ts
JOIN tasks t ON ts.task_id = t.id
WHERE ts.is_active = TRUE
  AND ts.next_run_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 1 HOUR)
ORDER BY ts.next_run_time;
```

### æŸ¥çœ‹æ‰§è¡Œå†å²

```sql
-- æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè®°å½•
SELECT 
  te.id,
  t.task_name,
  te.status,
  te.start_time,
  te.end_time,
  TIMESTAMPDIFF(SECOND, te.start_time, te.end_time) AS duration_seconds
FROM task_executions te
JOIN tasks t ON te.task_id = t.id
WHERE te.start_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY te.start_time DESC;
```

### Flower ç›‘æ§ç•Œé¢

è®¿é—® http://localhost:5555 æŸ¥çœ‹ï¼š
- ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
- Worker çŠ¶æ€
- ä»»åŠ¡é˜Ÿåˆ—æƒ…å†µ
- æ‰§è¡Œå†å²å’Œç»Ÿè®¡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºè®¾ç½®

ç³»ç»Ÿé»˜è®¤ä½¿ç”¨ `Asia/Shanghai` æ—¶åŒºï¼š

```python
# celery_beat_schedule.py
timezone = "Asia/Shanghai"
```

å¦‚éœ€ä¿®æ”¹æ—¶åŒºï¼Œè¯·åŒæ­¥ä¿®æ”¹ç›¸å…³é…ç½®ã€‚

### 2. é¿å…é‡å¤æ‰§è¡Œ

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```python
# å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè·³è¿‡æœ¬æ¬¡è°ƒåº¦
if running_execution:
    logger.info(f"ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è°ƒåº¦")
    return True
```

### 3. è°ƒåº¦å”¯ä¸€æ€§

æ¯ä¸ªä»»åŠ¡åŒæ—¶åªèƒ½æœ‰**ä¸€ä¸ªæ´»è·ƒçš„è°ƒåº¦**ï¼š

```python
# æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒçš„è°ƒåº¦
existing_schedule = await db.execute(
    select(TaskSchedule).where(
        TaskSchedule.task_id == task_id,
        TaskSchedule.is_active == True
    )
)
```

å¦‚éœ€ä¿®æ”¹è°ƒåº¦é…ç½®ï¼š
1. ç¦ç”¨æˆ–åˆ é™¤ç°æœ‰è°ƒåº¦
2. åˆ›å»ºæ–°çš„è°ƒåº¦é…ç½®

### 4. æ‰§è¡Œå»¶è¿Ÿ

- Celery Beat æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
- å®é™…æ‰§è¡Œæ—¶é—´å¯èƒ½æœ‰ 0-60 ç§’çš„å»¶è¿Ÿ
- å¯¹äºç²¾ç¡®æ—¶é—´è¦æ±‚é«˜çš„ä»»åŠ¡ï¼Œå»ºè®®æå‰é…ç½®

### 5. å®¹é”™æœºåˆ¶

- å¦‚æœè°ƒåº¦æ‰§è¡Œå¤±è´¥ï¼Œç³»ç»Ÿä¼šè®°å½•é”™è¯¯æ—¥å¿—
- `next_run_time` ä»ä¼šæ›´æ–°ï¼Œç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œ
- å¯é€šè¿‡ Flower æˆ–æ—¥å¿—æŸ¥çœ‹å¤±è´¥åŸå› 

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šè°ƒåº¦æœªæŒ‰æ—¶æ‰§è¡Œ

**å¯èƒ½åŸå› **ï¼š
1. Celery Beat æœªå¯åŠ¨
2. è°ƒåº¦è¢«ç¦ç”¨ï¼ˆ`is_active = false`ï¼‰
3. `next_run_time` è®¾ç½®é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥ Celery Beat æ˜¯å¦è¿è¡Œ
ps aux | grep "celery.*beat"

# 2. æŸ¥çœ‹è°ƒåº¦çŠ¶æ€
SELECT * FROM task_schedules WHERE task_id = 'your-task-id';

# 3. æŸ¥çœ‹ Celery Beat æ—¥å¿—
tail -f /path/to/celery-beat.log
```

---

### é—®é¢˜ 2ï¼šè°ƒåº¦åˆ›å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `ä»»åŠ¡å·²æœ‰æ´»è·ƒçš„è°ƒåº¦é…ç½®`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æŸ¥è¯¢ç°æœ‰è°ƒåº¦
curl -X GET "http://localhost:8089/api/v1/scheduler/task/{task_id}" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. åˆ é™¤ç°æœ‰è°ƒåº¦
curl -X DELETE "http://localhost:8089/api/v1/scheduler/{schedule_id}" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. åˆ›å»ºæ–°è°ƒåº¦
curl -X POST "http://localhost:8089/api/v1/scheduler/" ...
```

---

### é—®é¢˜ 3ï¼šä»»åŠ¡æœªæ‰§è¡Œ

**å¯èƒ½åŸå› **ï¼š
1. Celery Worker æœªå¯åŠ¨
2. ä»»åŠ¡é˜Ÿåˆ—é˜»å¡
3. Docker å®¹å™¨å¯åŠ¨å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥ Worker çŠ¶æ€
celery -A src.worker.main inspect active

# 2. æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè®°å½•
SELECT * FROM task_executions 
WHERE task_id = 'your-task-id' 
ORDER BY create_time DESC 
LIMIT 10;

# 3. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs task-{execution_id}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡æ‰§è¡Œæ–‡æ¡£](./ä»»åŠ¡æ‰§è¡Œ.md) - Docker å®¹å™¨åŒ–ä»»åŠ¡æ‰§è¡Œè¯´æ˜
- [å¿ƒè·³ç›‘æ§é…ç½®](./å¿ƒè·³ç›‘æ§é…ç½®.md) - ä»»åŠ¡ç›‘æ§å’Œå¿ƒè·³æœºåˆ¶
- [é¡¹ç›®æ¶æ„](./é¡¹ç›®æ¶æ„.md) - ç³»ç»Ÿæ•´ä½“æ¶æ„è¯´æ˜
- [æ•°æ®åº“ç®¡ç†](./æ•°æ®åº“ç®¡ç†.md) - æ•°æ®åº“ç›¸å…³æ“ä½œ

---

## ğŸ”— API æ–‡æ¡£

- Swagger UI: http://localhost:8089/docs
- ReDoc: http://localhost:8089/redoc

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
2. æ£€æŸ¥ Flower ç›‘æ§ç•Œé¢
3. æŸ¥çœ‹æ•°æ®åº“è°ƒåº¦è®°å½•
4. æäº¤ Issue æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-10-09  
**ç»´æŠ¤è€…**: Data Platform Team

