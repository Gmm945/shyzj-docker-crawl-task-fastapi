# 调度类型快速参考

## 📋 所有支持的调度类型

系统完整支持以下 **7 种**调度类型：

| # | 调度类型 | 枚举值 | 配置参数 | 示例 |
|---|---------|--------|---------|------|
| 1 | **立即执行** | `immediate` | 无 | `{}` |
| 2 | **定时执行** | `scheduled` | `datetime` | `{"datetime": "2025-10-15 14:30:00"}` |
| 3 | **分钟级调度** | `minutely` | `interval` | `{"interval": 5}` - 每5分钟 |
| 4 | **小时级调度** | `hourly` | `interval` | `{"interval": 2}` - 每2小时 |
| 5 | **每日调度** | `daily` | `time` | `{"time": "09:00:00"}` - 每天9点 |
| 6 | **周调度** | `weekly` | `days`, `time` | `{"days": [1,3,5], "time": "09:00:00"}` |
| 7 | **月调度** | `monthly` | `dates`, `time` | `{"dates": [1,15], "time": "09:00:00"}` |

---

## 🔧 API 调用示例

### 1. 每 5 分钟执行（高频采集）

```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "your-task-uuid",
    "schedule_type": "minutely",
    "schedule_config": {"interval": 5}
  }'
```

**适用场景**：
- 股票价格监控
- 实时数据采集
- 系统状态监控

---

### 2. 每 2 小时执行（定期同步）

```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "your-task-uuid",
    "schedule_type": "hourly",
    "schedule_config": {"interval": 2}
  }'
```

**适用场景**：
- 数据同步
- 定期备份
- 周期性检查

---

### 3. 每天固定时间执行（日常任务）

```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "your-task-uuid",
    "schedule_type": "daily",
    "schedule_config": {"time": "09:00:00"}
  }'
```

**适用场景**：
- 每日数据报表
- 每日数据汇总
- 每日清理任务

---

### 4. 每周固定时间执行（周期报表）

```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "your-task-uuid",
    "schedule_type": "weekly",
    "schedule_config": {
      "days": [1, 3, 5],
      "time": "09:00:00"
    }
  }'
```

**适用场景**：
- 工作日采集（周一到周五）
- 周报生成
- 定期数据分析

---

### 5. 每月固定日期执行（月度任务）

```bash
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "your-task-uuid",
    "schedule_type": "monthly",
    "schedule_config": {
      "dates": [1, 15],
      "time": "10:00:00"
    }
  }'
```

**适用场景**：
- 月度报表
- 账单数据采集
- 月度数据归档

---

## ⚙️ 调度时间间隔建议

| 调度类型 | 最小间隔 | 推荐间隔 | 说明 |
|---------|---------|---------|------|
| `minutely` | 1 分钟 | 5-10 分钟 | Celery Beat 每分钟检查一次 |
| `hourly` | 1 小时 | 2-6 小时 | 根据业务需求调整 |
| `daily` | 1 天 | 1 天 | 固定时间点执行 |
| `weekly` | 1 周 | 1 周 | 支持多天配置 |
| `monthly` | 1 月 | 1 月 | 支持多个日期 |

---

## 📊 调度类型选择决策树

```
需要调度任务？
│
├─ 只执行一次？
│  └─ 使用 scheduled（指定时间执行）
│
├─ 高频执行（分钟级）？
│  └─ 使用 minutely（每N分钟）
│
├─ 中频执行（小时级）？
│  └─ 使用 hourly（每N小时）
│
├─ 每天固定时间？
│  └─ 使用 daily（每天HH:MM:SS）
│
├─ 每周固定几天？
│  └─ 使用 weekly（周一到周日）
│
└─ 每月固定日期？
   └─ 使用 monthly（每月1-31号）
```

---

## ⚠️ 重要提示

1. **唯一性约束**：每个任务同时只能有一个活跃的调度配置
2. **时区设置**：系统默认使用 `Asia/Shanghai` 时区
3. **执行延迟**：Celery Beat 每分钟检查一次，可能有 0-60 秒延迟
4. **配置验证**：创建调度时会自动验证配置的有效性
5. **自动更新**：执行后会自动更新 `next_run_time`

---

## 🔍 验证调度配置

查询数据库验证调度是否生效：

```sql
SELECT 
  ts.id,
  t.task_name,
  ts.schedule_type,
  ts.schedule_config,
  ts.next_run_time,
  ts.is_active,
  ts.create_time
FROM task_schedules ts
JOIN tasks t ON ts.task_id = t.id
WHERE ts.is_active = TRUE
ORDER BY ts.next_run_time;
```

---

## 📚 相关文档

- [调度执行说明](./调度执行说明.md) - 完整的调度系统文档
- [Celery配置说明](./Celery配置说明.md) - Celery Beat 配置详解
- [API 文档](http://localhost:8089/docs) - Swagger 在线文档

---

**文档版本**: 1.0.0  
**最后更新**: 2025-10-09  
**维护者**: Data Platform Team

