# 项目架构说明

## 架构概述

本项目采用模块化架构设计，实现了清晰的职责分离和良好的可维护性。基于 FastAPI + Celery + MySQL + Redis 的现代化技术栈。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    数据采集任务管理系统                        │
├─────────────────────────────────────────────────────────────┤
│  Web层 (FastAPI)                                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 任务管理API │ │ 用户管理API │ │ 监控API     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  异步处理层 (Celery)                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 任务执行器  │ │ Docker管理  │ │ 调度器      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  容器执行层 (Docker)                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 爬虫容器    │ │ API容器     │ │ 数据库容器  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  数据层                                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ MySQL       │ │ Redis       │ │ 文件存储    │          │
│  │ 数据存储    │ │ 缓存/队列   │ │ 任务输出    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 项目结构

```
src/
├── main.py                          # 应用入口
├── config/                          # 配置模块
│   └── auth_config.py              # 认证配置
├── data_platform_api/               # 主业务模块
│   ├── models/                     # 数据模型
│   │   └── task.py                 # 任务相关模型
│   ├── schemas/                    # 数据模式
│   │   ├── common.py               # 通用模式
│   │   └── task.py                 # 任务模式
│   ├── routes/                     # API路由
│   │   ├── tasks.py                # 任务管理路由
│   │   ├── monitoring.py           # 监控路由
│   │   └── scheduler.py            # 调度路由
│   └── main.py                     # 模块入口
├── worker/                         # 异步任务模块
│   ├── main.py                     # Celery入口
│   ├── data_collection_tasks.py    # 数据采集任务
│   ├── file_tasks.py               # 文件处理任务
│   ├── db_tasks.py                 # 数据库任务
│   └── celeryconfig.py             # Celery配置
├── common/                         # 通用模块
│   └── schemas/                    # 通用数据模式
└── utils/                          # 工具模块
```

## 核心模块

### 1. Web API层 (`data_platform_api/`)

**功能**: 提供RESTful API接口
- **任务管理**: 创建、查询、停止任务
- **监控管理**: 心跳接收、状态查询
- **调度管理**: 定时任务配置
- **用户管理**: 认证和权限控制

**技术特点**:
- FastAPI框架，自动生成API文档
- Pydantic数据验证
- JWT Token认证
- 异步请求处理

### 2. 异步任务层 (`worker/`)

**功能**: 后台任务处理和调度
- **数据采集任务**: 爬虫、API、数据库任务执行
- **Docker管理**: 容器启动、监控、清理
- **文件处理**: 配置文件上传、输出文件管理
- **调度器**: 定时任务和周期性任务

**技术特点**:
- Celery异步任务队列
- Redis作为消息代理
- 支持任务优先级和重试
- 实时进度跟踪

### 3. 容器执行层

**功能**: 在Docker容器中执行具体任务
- **爬虫容器**: 网页数据采集
- **API容器**: 第三方API调用
- **数据库容器**: 数据同步和迁移

**技术特点**:
- 容器化隔离执行
- 配置文件挂载
- 心跳机制监控
- 优雅停止和清理

## 数据流设计

### 任务执行流程

```
1. 用户创建任务 → API接收请求
2. 任务入库 → 状态为PENDING
3. Celery调度 → 任务进入执行队列
4. Worker处理 → 启动Docker容器
5. 容器执行 → 发送心跳和进度
6. 任务完成 → 更新状态和结果
7. 资源清理 → 停止容器和清理文件
```

### 心跳监控流程

```
1. 容器启动 → 注册到监控系统
2. 定期心跳 → 30秒间隔发送状态
3. 进度更新 → 实时更新执行进度
4. 完成通知 → 任务结束时发送结果
5. 状态同步 → 数据库状态实时更新
```

## 技术特点

### 数据库设计
- **ORM**: SQLAlchemy 2.0
- **主键**: UUID字符串类型
- **软删除**: 使用`is_delete`字段
- **字段管理**: 支持容器名和容器ID分离存储

### 异步处理
- **任务队列**: Celery + Redis
- **进度跟踪**: 基于Redis的实时进度
- **调度器**: 支持定时和周期性任务
- **容器管理**: Docker容器的生命周期管理

### API设计
- **框架**: FastAPI
- **认证**: JWT Token
- **文档**: 自动生成Swagger文档
- **验证**: Pydantic数据验证

## 部署架构

### 服务组件
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web API       │    │   Celery Worker │    │   Celery Beat   │
│   (FastAPI)     │    │   (任务执行)     │    │   (任务调度)     │
│   Port: 8000    │    │   (后台处理)     │    │   (定时任务)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
         ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
         │     MySQL       │    │     Redis       │    │     Docker      │
         │   (数据存储)     │    │  (缓存/队列)    │    │  (容器执行)     │
         │   Port: 3306    │    │   Port: 6379    │    │   (动态端口)    │
         └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 环境配置
- **开发环境**: 本地开发配置
- **测试环境**: 自动化测试配置
- **生产环境**: 高可用生产配置

## 扩展指南

### 添加新任务类型
1. 在`worker/`目录下添加任务函数
2. 在`celeryconfig.py`中配置队列路由
3. 创建对应的Docker镜像
4. 更新API接口和文档

### 添加新功能模块
1. 在`data_platform_api/`下创建新模块
2. 定义模型、模式、路由
3. 添加相应的测试
4. 更新API文档

### 数据库变更
```bash
# 使用数据库管理工具
pdm run db:status    # 查看当前状态
pdm run db:reset     # 重置数据库（结构变更时）
```

## 监控和维护

### 健康检查
- API服务健康状态
- 数据库连接状态
- Redis连接状态
- 任务队列状态

### 日志管理
- 应用日志记录
- 错误日志跟踪
- 性能指标监控
- 容器执行日志

### 备份策略
- 数据库定期备份
- 配置文件版本控制
- 日志文件轮转

## 总结

本架构设计具有以下优势：

1. **模块化** - 清晰的职责分离
2. **可扩展** - 易于添加新功能
3. **可维护** - 统一的代码规范
4. **高性能** - 异步处理和缓存优化
5. **可监控** - 完善的日志和健康检查
6. **容器化** - 支持Docker容器化部署

通过这种架构设计，项目能够支持快速开发、稳定运行和持续演进。
