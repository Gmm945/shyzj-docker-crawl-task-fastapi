# 调度配置说明

## 概述

系统支持多种调度类型，可灵活配置任务的自动执行时间。本文档详细说明各种调度类型的配置方法和使用场景。

## 调度类型列表

| 调度类型 | 类型值 | 说明 | 支持状态 |
|---------|--------|------|---------|
| 即时执行 | `immediate` | 立即执行 | ✅ 已支持 |
| 指定时间 | `scheduled` | 指定时间执行一次 | ✅ 已支持 |
| 间隔执行 | `interval` | 按固定间隔重复执行 | ✅ 已支持 |
| 每天执行 | `daily` | 每天指定时间执行 | ✅ 已支持 |
| 每周执行 | `weekly` | 每周指定日期执行 | ✅ 已支持 |
| 每月执行 | `monthly` | 每月指定日期执行 | ✅ 已支持 |
| Cron表达式 | `cron` | 使用Cron表达式灵活定义 | ✅ 已支持 |

## 详细配置说明

### 1. 即时执行 (immediate)

**使用场景**：需要立即执行的任务

**配置示例**：
```json
{
  "schedule_type": "immediate",
  "schedule_config": {}
}
```

**说明**：
- 配置为空对象
- 创建后立即执行
- 执行后不会再次执行

---

### 2. 指定时间执行 (scheduled)

**使用场景**：需要在特定时间执行一次的任务

**配置示例**：
```json
{
  "schedule_type": "scheduled",
  "schedule_config": {
    "datetime": "2024-12-25 10:00:00"
  }
}
```

**配置说明**：
- `datetime`: 执行时间，格式：`YYYY-MM-DD HH:MM:SS`
- 执行后自动禁用调度
- 如果指定时间已过，则不会执行

---

### 3. 间隔执行 (interval)

**使用场景**：需要按固定间隔重复执行的任务

**配置示例**：
```json
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 60,
    "unit": "seconds"
  }
}
```

**配置说明**：
- `interval`: 间隔时间，必须大于0的整数
- `unit`: 时间单位，可选值：
  - `seconds`: 秒（默认）
  - `minutes`: 分钟
  - `hours`: 小时

**常见示例**：
```json
// 每5分钟执行一次
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 5,
    "unit": "minutes"
  }
}

// 每2小时执行一次
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 2,
    "unit": "hours"
  }
}

// 每30秒执行一次
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 30,
    "unit": "seconds"
  }
}
```

---

### 4. 每天执行 (daily)

**使用场景**：需要每天在同一时间执行的任务

**配置示例**：
```json
{
  "schedule_type": "daily",
  "schedule_config": {
    "time": "09:00:00"
  }
}
```

**配置说明**：
- `time`: 执行时间，格式：`HH:MM:SS`
- 小时范围：0-23
- 分钟范围：0-59
- 秒范围：0-59

**常见示例**：
```json
// 每天凌晨1点执行
{
  "schedule_type": "daily",
  "schedule_config": {
    "time": "01:00:00"
  }
}

// 每天下午3点30分执行
{
  "schedule_type": "daily",
  "schedule_config": {
    "time": "15:30:00"
  }
}
```

---

### 5. 每周执行 (weekly)

**使用场景**：需要每周在特定日期执行的任务

**配置示例**：
```json
{
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 3, 5],
    "time": "09:00:00"
  }
}
```

**配置说明**：
- `days`: 星期几执行，数组形式，1=周一，7=周日
- `time`: 执行时间，格式：`HH:MM:SS`

**星期对应关系**：
- 1 = 周一
- 2 = 周二
- 3 = 周三
- 4 = 周四
- 5 = 周五
- 6 = 周六
- 7 = 周日

**常见示例**：
```json
// 每周一到周五上午9点执行
{
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [1, 2, 3, 4, 5],
    "time": "09:00:00"
  }
}

// 每周末（周六、周日）执行
{
  "schedule_type": "weekly",
  "schedule_config": {
    "days": [6, 7],
    "time": "10:00:00"
  }
}
```

---

### 6. 每月执行 (monthly)

**使用场景**：需要每月在特定日期执行的任务

**配置示例**：
```json
{
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1, 15, -1],
    "time": "09:00:00"
  }
}
```

**配置说明**：
- `dates`: 每月几号执行，数组形式，取值范围：1-31 或 -1
- `time`: 执行时间，格式：`HH:MM:SS`
- **特殊值 `-1`**: 表示每月最后一天，自动适配不同月份的天数

**日期不存在处理**：
- 如果某个日期在该月不存在（如2月30日），系统会自动跳过该日期
- 例如：`{"dates": [28, 29, 30, 31]}` 在2月只会执行28号和29号

**每月最后一天 (`-1`)**：
- 自动适配不同月份的天数
- 1月：31号
- 2月（平年）：28号
- 2月（闰年）：29号
- 4月：30号

**常见示例**：
```json
// 每月1号和15号执行
{
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1, 15],
    "time": "09:00:00"
  }
}

// 每月最后一天执行
{
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [-1],
    "time": "09:00:00"
  }
}

// 每月1号、15号和最后一天执行
{
  "schedule_type": "monthly",
  "schedule_config": {
    "dates": [1, 15, -1],
    "time": "09:00:00"
  }
}
```

---

### 7. Cron表达式 (cron)

**使用场景**：需要灵活定义执行时间的复杂调度

**配置示例**：
```json
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "0 0 * * *"
  }
}
```

**配置说明**：
- `cron_expression`: Cron表达式，格式：`分 时 日 月 星期`

**Cron表达式格式**：
```
┌───────────── 分钟 (0 - 59)
│ ┌───────────── 小时 (0 - 23)
│ │ ┌───────────── 日期 (1 - 31)
│ │ │ ┌───────────── 月份 (1 - 12)
│ │ │ │ ┌───────────── 星期 (0 - 6, 0或7表示周日)
│ │ │ │ │
* * * * *
```

**特殊字符**：
- `*`: 匹配所有值
- `,`: 指定多个值
- `-`: 指定范围
- `/`: 指定间隔

**常见示例**：
```json
// 每天凌晨0点执行
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "0 0 * * *"
  }
}

// 每周一上午9点执行
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "0 9 * * 1"
  }
}

// 每月1号执行
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "0 0 1 * *"
  }
}

// 每30分钟执行一次
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "*/30 * * * *"
  }
}

// 每月的最后一天执行
{
  "schedule_type": "cron",
  "schedule_config": {
    "cron_expression": "0 0 L * *"
  }
}
```

---

## 调度器执行流程

1. **定时检查**：Celery Beat 每分钟检查一次需要执行的任务
2. **查询条件**：查询 `next_run_time <= now()` 的任务
3. **执行任务**：符合条件的任务会被提交到 Celery Worker 执行
4. **更新下次执行时间**：执行后自动计算并更新 `next_run_time`
5. **特殊处理**：`scheduled` 类型执行后自动禁用

## 调度配置更新

### 更新方式

创建自动任务时，可以在创建任务时指定调度配置，也可以后续通过更新接口修改调度配置。

**创建任务时指定调度**：
```json
{
  "task_name": "示例任务",
  "task_type": "docker-crawl",
  "trigger_method": "auto",
  "schedule_type": "daily",
  "schedule_config": {
    "time": "09:00:00"
  }
}
```

**更新任务的调度配置**：
```bash
PUT /api/v1/task/{task_id}
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 60,
    "unit": "minutes"
  }
}
```

### 更新逻辑

- 更新调度配置时，系统会**删除旧调度，创建新调度**
- 确保每次更新后只有一个有效的调度配置
- 更新后立即生效，下次执行时间会重新计算

## 注意事项

1. **时区**：所有时间默认使用服务器本地时区
2. **日期不存在**：月调度中不存在的日期会被自动跳过
3. **任务状态**：只有状态为 `active` 的任务才会被调度执行
4. **并发控制**：如果任务正在执行中，不会重复启动
5. **执行失败**：任务执行失败不会自动重试，需要手动重新执行或调整调度

## 常见问题

### Q: 如何实现每N分钟执行一次？
A: 使用 `interval` 类型，设置 `unit` 为 `minutes`。

### Q: 如何实现每月最后一天执行？
A: 使用 `monthly` 类型，设置 `dates` 为 `[-1]`。

### Q: 如何实现每周末执行？
A: 使用 `weekly` 类型，设置 `days` 为 `[6, 7]`。

### Q: 如何实现更复杂的调度？
A: 使用 `cron` 类型，通过 Cron 表达式灵活定义。

### Q: 调度配置更新后何时生效？
A: 立即生效，下次执行时间会重新计算。

### Q: 如何禁用自动调度？
A: 将任务的 `trigger_method` 改为 `manual`，或删除调度配置。

## 兼容性说明

### 旧版本兼容

- 旧版本的 `minutely` 和 `hourly` 已合并为 `interval` 类型
- 建议使用 `interval` + `unit` 参数替代

**迁移示例**：
```json
// 旧版本（已废弃）
{
  "schedule_type": "minutely",
  "schedule_config": {
    "interval": 5
  }
}

// 新版本（推荐）
{
  "schedule_type": "interval",
  "schedule_config": {
    "interval": 5,
    "unit": "minutes"
  }
}
```

## 参考资源

- [Cron表达式详解](https://crontab.guru/)
- [API使用指南](./API使用指南.md)
- [安装配置说明](./安装配置.md)
