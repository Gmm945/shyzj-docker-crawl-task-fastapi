# ğŸ” Casbin æƒé™ç®¡ç†ç³»ç»Ÿ - ä½¿ç”¨æ‰‹å†Œ

> å‚ç…§ aks-management é¡¹ç›®å®ç°çš„å®Œæ•´æƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [é»˜è®¤è§’è‰²æƒé™](#é»˜è®¤è§’è‰²æƒé™)
4. [æ¥å£æƒé™æ˜ å°„](#æ¥å£æƒé™æ˜ å°„)
5. [æƒé™ç®¡ç†æ“ä½œ](#æƒé™ç®¡ç†æ“ä½œ)
6. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“

```bash
# é‡ç½®æ•°æ®åº“ï¼ˆåˆ›å»ºæ‰€æœ‰è¡¨ï¼‰
pdm run db:reset
```

### 2. åˆå§‹åŒ–æƒé™æ•°æ®

```bash
# åˆ›å»ºé»˜è®¤è§’è‰²ã€ç”¨æˆ·å’Œæƒé™è§„åˆ™
pdm run python -m src.db_util.init_data
```

**å°†åˆ›å»º:**
- **3ä¸ªé»˜è®¤è§’è‰²**: system_admin, task_manager, user
- **3ä¸ªé»˜è®¤ç”¨æˆ·**: admin/admin123, task_manager/manager123, user01/user123
- **71æ¡æƒé™è§„åˆ™**
- **10ä¸ªèµ„æºå¯¹è±¡**
- **7ä¸ªåŠ¨ä½œç±»å‹**

### 3. å¯åŠ¨æœåŠ¡

```bash
pdm run start
```

### 4. è®¿é—® API æ–‡æ¡£

```
http://localhost:8089/api/v1/docs
```

### 5. æµ‹è¯•æƒé™

```bash
# ç™»å½•
curl -X POST "http://localhost:8089/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'

# ä½¿ç”¨è¿”å›çš„ token è®¿é—®æ¥å£
curl -X GET "http://localhost:8089/api/v1/role/list" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

#### 1. Casbin Enforcer (`src/db_util/db.py`)

```python
# å…¨å±€ Adapter
adapter = Adapter(sessionmanager._engine)

async def get_casbin_e():
    """
    æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°çš„ enforcer å¹¶åŠ è½½ç­–ç•¥
    é¿å…äº‹ä»¶å¾ªç¯å†²çªï¼Œç¡®ä¿ç­–ç•¥å®æ—¶æ€§
    """
    model_path = os.path.join(BASE_DIR, 'rbac_model.conf')
    enforcer = casbin.AsyncEnforcer(model_path, adapter)
    await enforcer.load_policy()
    return enforcer
```

#### 2. æƒé™æ£€æŸ¥è£…é¥°å™¨ (`src/user_manage/service/security.py`)

```python
def check_permissions(obj: str = None, ex_rule: str = None):
    """
    æƒé™æ£€æŸ¥è£…é¥°å™¨
    - obj: èµ„æºå¯¹è±¡ï¼ˆå¦‚ "Task"ï¼‰
    - ex_rule: è‡ªå®šä¹‰åŠ¨ä½œï¼ˆé»˜è®¤ä½¿ç”¨ HTTP æ–¹æ³•ï¼‰
    """
```

**ç”¨æ³•:**
```python
@router.post("/tasks")
async def create_task(user: User = Depends(check_permissions("Task"))):
    # è‡ªåŠ¨æ£€æŸ¥ Task:POST æƒé™
    pass
```

#### 3. æ‰¹é‡æƒé™éªŒè¯ (`src/user_manage/utils.py`)

```python
async def batch_verify_enforces(enforces):
    """æ‰¹é‡éªŒè¯å¤šä¸ªæƒé™è§„åˆ™"""
    e = await get_casbin_e()
    return e.batch_enforce(enforces)  # æ³¨æ„ï¼šbatch_enforce æ˜¯åŒæ­¥æ–¹æ³•
```

### æ•°æ®åº“æ¨¡å‹

#### æ ¸å¿ƒè¡¨

| è¡¨å | è¯´æ˜ | ä¸»è¦å­—æ®µ |
|------|------|---------|
| `casbin_rule` | Casbin è§„åˆ™è¡¨ï¼ˆæ ¸å¿ƒï¼‰ | ptype, v0(è§’è‰²), v1(å¯¹è±¡), v2(åŠ¨ä½œ) |
| `role` | è§’è‰²è¡¨ | id, name, role_key, description |
| `mid_user_role` | ç”¨æˆ·è§’è‰²å…³è”è¡¨ | uid, rid |

#### è¾…åŠ©è¡¨

| è¡¨å | è¯´æ˜ |
|------|------|
| `casbin_object` | èµ„æºå¯¹è±¡å®šä¹‰ |
| `casbin_action` | åŠ¨ä½œå®šä¹‰ |
| `casbin_permission` | æƒé™å®šä¹‰ï¼ˆå¯¹è±¡+åŠ¨ä½œï¼‰ |

### RBAC æ¨¡å‹é…ç½®

```ini
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act
```

---

## ğŸ‘¥ é»˜è®¤è§’è‰²æƒé™

### role_sysadmin (ç³»ç»Ÿç®¡ç†å‘˜)

**æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼š**
- âœ… User: POST, GET, PUT, DELETE, PATCH
- âœ… Role: POST, GET, PUT, DELETE
- âœ… Task: POST, GET, PUT, DELETE, EXECUTE, STOP
- âœ… Scheduler: POST, GET, PUT, DELETE
- âœ… Monitoring: POST, GET, PUT, DELETE
- âœ… Common: GET
- âœ… CasbinObject, CasbinAction, CasbinRule, Perm: æ‰€æœ‰æƒé™

**é»˜è®¤è´¦å·:** `admin` / `admin123`

### role_task_manager (ä»»åŠ¡ç®¡ç†å‘˜)

**ä»»åŠ¡å’Œè°ƒåº¦ç®¡ç†æƒé™ï¼š**
- âœ… Task: POST, GET, PUT, DELETE, EXECUTE, STOP
- âœ… Scheduler: POST, GET, PUT, DELETE
- âœ… Monitoring: POST, GET, PUT, DELETE
- âœ… Common: GET

**é»˜è®¤è´¦å·:** `task_manager` / `manager123`

### role_user (æ™®é€šç”¨æˆ·)

**åªè¯»å’Œæ‰§è¡Œæƒé™ï¼š**
- âœ… Task: GET, EXECUTE
- âœ… Common: GET

**é»˜è®¤è´¦å·:** `user01` / `user123`

---

## ğŸ“ æ¥å£æƒé™æ˜ å°„

### Task ä»»åŠ¡ç®¡ç† (`/api/v1/task/*`)

| æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/add` | POST | Task:POST | åˆ›å»ºä»»åŠ¡ |
| `/list` | GET | Task:GET | æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ |
| `/{task_id}` | GET | Task:GET | æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ… |
| `/{task_id}` | PUT | Task:PUT | æ›´æ–°ä»»åŠ¡ |
| `/{task_id}` | DELETE | Task:DELETE | åˆ é™¤ä»»åŠ¡ |
| `/{task_id}/execute` | POST | **Task:EXECUTE** | æ‰§è¡Œä»»åŠ¡ |
| `/{task_id}/stop` | POST | **Task:STOP** | åœæ­¢ä»»åŠ¡ |
| `/{task_id}/executions` | GET | Task:GET | æŸ¥çœ‹æ‰§è¡Œè®°å½• |
| `/{task_id}/status` | GET | Task:GET | æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ |
| `/{task_id}/activate` | POST | Task:POST | æ¿€æ´»ä»»åŠ¡ |
| `/{task_id}/deactivate` | POST | Task:POST | åœç”¨ä»»åŠ¡ |

### Scheduler è°ƒåº¦ç®¡ç† (`/api/v1/scheduler/*`)

| æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/` | POST | Scheduler:POST | åˆ›å»ºè°ƒåº¦ |
| `/task/{task_id}` | GET | Scheduler:GET | æŸ¥çœ‹ä»»åŠ¡è°ƒåº¦ |
| `/{schedule_id}/toggle` | PUT | Scheduler:PUT | åˆ‡æ¢è°ƒåº¦çŠ¶æ€ |
| `/{schedule_id}` | DELETE | Scheduler:DELETE | åˆ é™¤è°ƒåº¦ |

### Monitoring ç›‘æ§ç®¡ç† (`/api/v1/monitoring/*`)

| æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/execution/{execution_id}/status` | GET | Monitoring:GET | æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€ |
| `/executions/active` | GET | Monitoring:GET | æŸ¥çœ‹æ´»è·ƒä»»åŠ¡ |
| `/statistics` | GET | Monitoring:GET | æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ |
| `/heartbeat` | POST | **æ— éœ€æƒé™** | å®¹å™¨å¿ƒè·³ |
| `/completion` | POST | **æ— éœ€æƒé™** | å®Œæˆé€šçŸ¥ |
| `/check-timeouts` | POST | Monitoring:POST | æ£€æŸ¥è¶…æ—¶ |

### Role è§’è‰²ç®¡ç† (`/api/v1/role/*`)

| æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/add` | POST | Role:POST | åˆ›å»ºè§’è‰² |
| `/list` | GET | Role:GET | æŸ¥çœ‹è§’è‰²åˆ—è¡¨ |
| `/{role_id}` | GET | Role:GET | æŸ¥çœ‹è§’è‰²è¯¦æƒ… |
| `/{role_id}` | PUT | Role:PUT | æ›´æ–°è§’è‰² |
| `/{role_id}` | DELETE | Role:DELETE | åˆ é™¤è§’è‰² |
| `/{role_id}/save_perms` | PUT | Role:PUT | ä¿å­˜è§’è‰²æƒé™ |
| `/{role_id}/perms` | GET | Role:GET | æŸ¥çœ‹è§’è‰²æƒé™ |
| `/change_user_roles` | PUT | Role:PUT | ä¿®æ”¹ç”¨æˆ·è§’è‰² |
| `/get_roles_by_uid/{user_id}` | GET | Role:GET | æŸ¥çœ‹ç”¨æˆ·è§’è‰² |

### Common å…¬å…±èµ„æº (`/api/v1/common/*`)

| æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/health` | GET | **æ— éœ€æƒé™** | å¥åº·æ£€æŸ¥ |
| `/health/liveness` | GET | **æ— éœ€æƒé™** | å­˜æ´»æ£€æŸ¥ |
| `/health/readiness` | GET | **æ— éœ€æƒé™** | å°±ç»ªæ£€æŸ¥ |
| `/stats` | GET | Common:GET | ç³»ç»Ÿç»Ÿè®¡ |

---

## ğŸ› ï¸ æƒé™ç®¡ç†æ“ä½œ

### 1. æŸ¥çœ‹æ‰€æœ‰è§’è‰²

```bash
curl -X GET "http://localhost:8089/api/v1/role/list" \
  -H "Authorization: Bearer $TOKEN"
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "message": "è·å–è§’è‰²åˆ—è¡¨æˆåŠŸ",
  "data": {
    "total": 3,
    "roles": [
      {
        "id": "uuid",
        "name": "ç³»ç»Ÿç®¡ç†å‘˜",
        "role_key": "role_sysadmin",
        "user_count": 1,
        "description": "æ‹¥æœ‰æ‰€æœ‰ç³»ç»Ÿæƒé™"
      }
    ]
  }
}
```

### 2. æŸ¥çœ‹è§’è‰²çš„æƒé™

```bash
curl -X GET "http://localhost:8089/api/v1/role/{role_id}/perms" \
  -H "Authorization: Bearer $TOKEN"
```

### 3. åˆ›å»ºè‡ªå®šä¹‰è§’è‰²

```bash
curl -X POST "http://localhost:8089/api/v1/role/add" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æ•°æ®åˆ†æå¸ˆ",
    "description": "åªèƒ½æŸ¥çœ‹å’Œåˆ†ææ•°æ®"
  }'
```

### 4. ä¸ºè§’è‰²åˆ†é…æƒé™

```bash
curl -X PUT "http://localhost:8089/api/v1/role/{role_id}/save_perms" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "permissions": [
      "Task:GET",
      "Task:EXECUTE",
      "Monitoring:GET",
      "Common:GET"
    ]
  }'
```

### 5. ä¸ºç”¨æˆ·åˆ†é…è§’è‰²

```bash
curl -X PUT "http://localhost:8089/api/v1/role/change_user_roles" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "uid": "user_uuid",
    "rids": ["role_uuid1", "role_uuid2"]
  }'
```

### 6. æŸ¥çœ‹ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²

```bash
curl -X GET "http://localhost:8089/api/v1/role/get_roles_by_uid/{user_id}" \
  -H "Authorization: Bearer $TOKEN"
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒå®ç°ï¼ˆå‚ç…§ aks-managementï¼‰

#### 1. get_casbin_e() - æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°å®ä¾‹

```python
async def get_casbin_e():
    # æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°çš„ AsyncEnforcer
    enforcer = casbin.AsyncEnforcer(model_path, adapter)
    await enforcer.load_policy()  # åŠ è½½æœ€æ–°ç­–ç•¥
    return enforcer
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- âœ… é¿å… AsyncEnforcer çš„äº‹ä»¶å¾ªç¯å†²çª
- âœ… æ¯æ¬¡éƒ½åŠ è½½æœ€æ–°ç­–ç•¥ï¼Œç¡®ä¿å®æ—¶æ€§
- âœ… ç®€åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… å®Œå…¨å‚ç…§ aks-management å®ç°

#### 2. batch_enforce - æ³¨æ„æ˜¯åŒæ­¥æ–¹æ³•

```python
e = await get_casbin_e()          # å¼‚æ­¥è·å– enforcer
results = e.batch_enforce(batch)  # åŒæ­¥è°ƒç”¨ï¼ˆä¸éœ€è¦ awaitï¼‰
```

**é‡è¦:** AsyncEnforcer çš„ `enforce()` å’Œ `batch_enforce()` éƒ½æ˜¯**åŒæ­¥æ–¹æ³•**ï¼

#### 3. æƒé™æ£€æŸ¥æµç¨‹

```
è¯·æ±‚ â†’ OAuth2 éªŒè¯ â†’ è·å–ç”¨æˆ·
  â†“
æŸ¥è¯¢ç”¨æˆ·è§’è‰² (mid_user_role)
  â†“
æ‰¹é‡æ£€æŸ¥æƒé™ (batch_enforce)
  â†“
  â”œâ”€ æœ‰æƒé™ â†’ ç»§ç»­æ‰§è¡Œ
  â””â”€ æ— æƒé™ â†’ è¿”å› 403
```

### æ•°æ®åº“è¡¨ç»“æ„

#### casbin_ruleï¼ˆæ ¸å¿ƒè§„åˆ™è¡¨ï¼‰

```sql
CREATE TABLE casbin_rule (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ptype VARCHAR(255),  -- 'p' ç­–ç•¥ æˆ– 'g' ç»„å…³ç³»
    v0 VARCHAR(255),     -- è§’è‰²key
    v1 VARCHAR(255),     -- èµ„æºå¯¹è±¡
    v2 VARCHAR(255),     -- åŠ¨ä½œ
    v3-v5 VARCHAR(255)   -- æ‰©å±•å­—æ®µ
);
```

**ç¤ºä¾‹æ•°æ®:**
```
# ç­–ç•¥è§„åˆ™ (p): è§’è‰²æ‹¥æœ‰çš„æƒé™
ptype='p', v0='role_sysadmin', v1='Task', v2='POST'  â†’ ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä»»åŠ¡
ptype='p', v0='role_user', v1='Task', v2='GET'       â†’ æ™®é€šç”¨æˆ·å¯ä»¥æŸ¥çœ‹ä»»åŠ¡

# ç»„è§„åˆ™ (g): ç”¨æˆ·å±äºçš„è§’è‰²
ptype='g', v0='user_123', v1='role_sysadmin'  â†’ user_123 æ˜¯ç³»ç»Ÿç®¡ç†å‘˜
```

#### å…¶ä»–è¡¨

- **role**: è§’è‰²ä¿¡æ¯ï¼ˆid, name, role_key, descriptionï¼‰
- **mid_user_role**: ç”¨æˆ·è§’è‰²ç»‘å®šï¼ˆuid, ridï¼‰
- **casbin_object**: èµ„æºå¯¹è±¡å®šä¹‰
- **casbin_action**: åŠ¨ä½œå®šä¹‰
- **casbin_permission**: æƒé™å®šä¹‰

---

## ğŸ“Š æ¥å£æƒé™è¯¦ç»†è¯´æ˜

### æ’é™¤æƒé™æ§åˆ¶çš„æ¥å£ï¼ˆç™½åå•ï¼‰

#### 1. Docker å®¹å™¨äº¤äº’æ¥å£
- `POST /monitoring/heartbeat` - å®¹å™¨å¿ƒè·³ä¸ŠæŠ¥ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰
- `POST /monitoring/completion` - ä»»åŠ¡å®Œæˆé€šçŸ¥ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰

#### 2. å¥åº·æ£€æŸ¥æ¥å£
- `GET /common/health` - åŸºç¡€å¥åº·æ£€æŸ¥
- `GET /common/health/liveness` - Kubernetes å­˜æ´»æ£€æŸ¥
- `GET /common/health/readiness` - Kubernetes å°±ç»ªæ£€æŸ¥

#### 3. è®¤è¯æ¥å£
- `POST /auth/login` - ç”¨æˆ·ç™»å½•
- `POST /auth/register` - ç”¨æˆ·æ³¨å†Œ

#### 4. ç™½åå•è·¯å¾„ï¼ˆå®‰å…¨æœåŠ¡ä¸­é…ç½®ï¼‰
- `user/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `auth/reset_password` - é‡ç½®å¯†ç 
- `auth/logout` - ç™»å‡º
- `auth/refresh` - åˆ·æ–° token

### ç‰¹æ®Šæƒé™æ˜ å°„

| æ¥å£ | HTTP æ–¹æ³• | æƒé™åŠ¨ä½œ | è¯´æ˜ |
|------|----------|---------|------|
| `/{task_id}/execute` | POST | `EXECUTE` | è‡ªå®šä¹‰åŠ¨ä½œ |
| `/{task_id}/stop` | POST | `STOP` | è‡ªå®šä¹‰åŠ¨ä½œ |
| å…¶ä»–åˆ›å»ºæ¥å£ | POST | `POST` | é»˜è®¤æ˜ å°„ |
| å…¶ä»–æŸ¥è¯¢æ¥å£ | GET | `GET` | é»˜è®¤æ˜ å°„ |
| å…¶ä»–æ›´æ–°æ¥å£ | PUT | `PUT` | é»˜è®¤æ˜ å°„ |
| å…¶ä»–åˆ é™¤æ¥å£ | DELETE | `DELETE` | é»˜è®¤æ˜ å°„ |

---

## ğŸ¯ å¼€å‘æŒ‡å—

### ä¸ºæ–°æ¥å£æ·»åŠ æƒé™æ§åˆ¶

```python
from ...user_manage.service.security import check_permissions

router = APIRouter()
obj = 'YourResource'  # å®šä¹‰èµ„æºå¯¹è±¡åç§°

# 1. ä½¿ç”¨é»˜è®¤ HTTP æ–¹æ³•æ˜ å°„
@router.post("/your_endpoint")
async def your_api(
    user: User = Depends(check_permissions(obj))
):
    # è‡ªåŠ¨æ£€æŸ¥ YourResource:POST æƒé™
    pass

# 2. ä½¿ç”¨è‡ªå®šä¹‰åŠ¨ä½œ
@router.post("/your_endpoint/custom")
async def your_custom_api(
    user: User = Depends(check_permissions(obj, "CUSTOM_ACTION"))
):
    # æ£€æŸ¥ YourResource:CUSTOM_ACTION æƒé™
    pass

# 3. æŸäº›æ¥å£ä¸éœ€è¦æƒé™æ£€æŸ¥
@router.get("/public")
async def public_api():
    # ä¸æ·»åŠ  check_permissions
    pass
```

### æƒé™å‘½åè§„èŒƒ

**èµ„æºå¯¹è±¡ (Object):**
- ä½¿ç”¨å¤§å†™å¼€å¤´é©¼å³°å‘½å: `Task`, `User`, `Role`, `Scheduler`
- ä¸ä¸šåŠ¡æ¨¡å—å¯¹åº”

**åŠ¨ä½œ (Action):**
- HTTP æ–¹æ³•: `POST`, `GET`, `PUT`, `DELETE`, `PATCH`
- è‡ªå®šä¹‰åŠ¨ä½œ: `EXECUTE`, `STOP`, `VIEW`, `DOWNLOAD`

---

## ğŸ” æƒé™ç®¡ç†æœ€ä½³å®è·µ

### 1. è§’è‰²è®¾è®¡åŸåˆ™

- **æœ€å°æƒé™åŸåˆ™**: åªç»™äºˆå¿…è¦çš„æƒé™
- **èŒè´£åˆ†ç¦»**: ä¸åŒè§’è‰²è´Ÿè´£ä¸åŒåŠŸèƒ½
- **å¤šè§’è‰²æ”¯æŒ**: ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼ˆæƒé™å–å¹¶é›†ï¼‰
- **ç³»ç»Ÿè§’è‰²ä¿æŠ¤**: ä¸è¦ä¿®æ”¹æˆ–åˆ é™¤ç³»ç»Ÿé»˜è®¤è§’è‰²

### 2. æƒé™åˆ†é…æµç¨‹

```
1. å®šä¹‰ä¸šåŠ¡è§’è‰²ï¼ˆå¦‚ï¼šæ•°æ®åˆ†æå¸ˆï¼‰
   â†“
2. ç¡®å®šè§’è‰²éœ€è¦çš„æƒé™
   â†“
3. åˆ›å»ºè§’è‰²å¹¶åˆ†é…æƒé™
   â†“
4. ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
   â†“
5. æµ‹è¯•éªŒè¯æƒé™
```

### 3. å®‰å…¨å»ºè®®

- å®šæœŸå®¡è®¡è§’è‰²æƒé™é…ç½®
- è®°å½•æƒé™å˜æ›´æ—¥å¿—
- ç›‘æ§å¼‚å¸¸æƒé™è®¿é—®
- å®šæœŸæ¸…ç†æ— ç”¨è§’è‰²
- å¤‡ä»½ casbin_rule è¡¨

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¿”å› 403 æƒé™ä¸è¶³

**å¯èƒ½åŸå› :**
1. ç”¨æˆ·æœªåˆ†é…è§’è‰²
2. è§’è‰²æœªåˆ†é…å¯¹åº”æƒé™
3. Token å·²è¿‡æœŸ

**æ’æŸ¥æ­¥éª¤:**
```bash
# 1. æ£€æŸ¥ç”¨æˆ·è§’è‰²
curl -X GET "http://localhost:8089/api/v1/role/get_roles_by_uid/{user_id}" \
  -H "Authorization: Bearer $TOKEN"

# 2. æ£€æŸ¥è§’è‰²æƒé™
curl -X GET "http://localhost:8089/api/v1/role/{role_id}/perms" \
  -H "Authorization: Bearer $TOKEN"

# 3. æ£€æŸ¥æ•°æ®åº“ä¸­çš„è§„åˆ™
SELECT * FROM casbin_rule WHERE ptype='p' AND v0='role_key';
SELECT * FROM mid_user_role WHERE uid='user_id';

# 4. é‡æ–°ç™»å½•è·å–æ–° token
curl -X POST "http://localhost:8089/api/v1/auth/login" ...
```

### é—®é¢˜ 2: åˆå§‹åŒ–æ•°æ®å¤±è´¥

**åŸå› :** æ•°æ®åº“è¡¨ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•:**
```bash
# 1. å…ˆåˆå§‹åŒ–æ•°æ®åº“è¡¨
pdm run db:reset

# 2. å†è¿è¡Œåˆå§‹åŒ–æ•°æ®
pdm run python -m src.db_util.init_data
```

### é—®é¢˜ 3: æƒé™è§„åˆ™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ¸…å•:**
- [ ] casbin_rule è¡¨ä¸­æ˜¯å¦æœ‰å¯¹åº”è§„åˆ™
- [ ] mid_user_role è¡¨ä¸­æ˜¯å¦æœ‰ç”¨æˆ·è§’è‰²ç»‘å®š
- [ ] è§’è‰²çš„ role_key æ˜¯å¦æ­£ç¡®
- [ ] èµ„æºå¯¹è±¡å’ŒåŠ¨ä½œåç§°æ˜¯å¦åŒ¹é…

**è°ƒè¯•æ–¹æ³•:**
```sql
-- æŸ¥çœ‹è§’è‰²çš„æ‰€æœ‰æƒé™
SELECT * FROM casbin_rule 
WHERE ptype='p' AND v0='role_sysadmin';

-- æŸ¥çœ‹ç”¨æˆ·çš„è§’è‰²
SELECT r.* FROM role r
JOIN mid_user_role m ON r.id = m.rid
WHERE m.uid = 'user_id';
```

---

## ğŸ“š æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### æ•°æ®åº“å’Œé…ç½®
- `src/db_util/db.py` - Casbin Enforcer åˆå§‹åŒ–
- `src/db_util/rbac_model.conf` - RBAC æ¨¡å‹é…ç½®
- `src/db_util/init_data.py` - æ•°æ®åˆå§‹åŒ–è„šæœ¬

### æƒé™æœåŠ¡
- `src/user_manage/service/security.py` - æƒé™æ£€æŸ¥è£…é¥°å™¨
- `src/user_manage/service/role_service.py` - è§’è‰²CRUDæœåŠ¡
- `src/user_manage/service/casbin_permission.py` - Casbinè§„åˆ™ç®¡ç†
- `src/user_manage/utils.py` - æ‰¹é‡æƒé™éªŒè¯

### æ•°æ®æ¨¡å‹
- `src/user_manage/models/casbin.py` - Casbin æ•°æ®åº“æ¨¡å‹
- `src/user_manage/models/role.py` - è§’è‰²æ•°æ®åº“æ¨¡å‹
- `src/user_manage/schemas/casbin.py` - Casbin Pydantic schemas
- `src/user_manage/schemas/role.py` - è§’è‰² Pydantic schemas

### API è·¯ç”±
- `src/user_manage/routes/role.py` - è§’è‰²ç®¡ç† API
- `src/data_platform_api/routes/tasks.py` - ä»»åŠ¡APIï¼ˆå·²æ·»åŠ æƒé™ï¼‰
- `src/data_platform_api/routes/scheduler.py` - è°ƒåº¦APIï¼ˆå·²æ·»åŠ æƒé™ï¼‰
- `src/data_platform_api/routes/monitoring.py` - ç›‘æ§APIï¼ˆå·²æ·»åŠ æƒé™ï¼‰

---

## ğŸ“– API è°ƒç”¨ç¤ºä¾‹

### å®Œæ•´å·¥ä½œæµç¨‹

```bash
# 1. ç™»å½•è·å– Token
TOKEN=$(curl -s -X POST "http://localhost:8089/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' \
  | jq -r '.data.access_token')

# 2. åˆ›å»ºä»»åŠ¡
TASK_RESPONSE=$(curl -s -X POST "http://localhost:8089/api/v1/task/add" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_name": "ç¤ºä¾‹ä»»åŠ¡",
    "task_type": "docker-crawl",
    "base_url": "https://httpbin.org/get",
    "description": "ç¤ºä¾‹ä»»åŠ¡"
  }')

TASK_ID=$(echo "$TASK_RESPONSE" | jq -r '.data.task_id')

# 3. åˆ›å»ºè°ƒåº¦
curl -X POST "http://localhost:8089/api/v1/scheduler/" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"task_id\": \"$TASK_ID\",
    \"schedule_type\": \"daily\",
    \"schedule_config\": {\"time\": \"09:00:00\"},
    \"is_active\": true
  }"

# 4. æŸ¥çœ‹è°ƒåº¦é…ç½®
curl -X GET "http://localhost:8089/api/v1/scheduler/task/$TASK_ID" \
  -H "Authorization: Bearer $TOKEN"

# 5. æ‰§è¡Œä»»åŠ¡
curl -X POST "http://localhost:8089/api/v1/task/$TASK_ID/execute" \
  -H "Authorization: Bearer $TOKEN"
```

---

## âš¡ æ€§èƒ½è¯´æ˜

### æ¯æ¬¡æƒé™æ£€æŸ¥çš„å¼€é”€

```
1. OAuth2 éªŒè¯        ~1ms
2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯       ~1ms (å·²åœ¨ token ä¸­)
3. æŸ¥è¯¢ç”¨æˆ·è§’è‰²       ~2ms
4. åˆ›å»º Enforcer      ~1ms
5. åŠ è½½ç­–ç•¥          ~5-10ms
6. æ‰¹é‡éªŒè¯          ~1ms
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:               ~10-15ms/è¯·æ±‚
```

**ä¼˜åŒ–å»ºè®®:**
- è€ƒè™‘æ·»åŠ  Redis ç¼“å­˜ç”¨æˆ·è§’è‰²
- è€ƒè™‘ç¼“å­˜ Enforcer å®ä¾‹ï¼ˆéœ€è¦å¤„ç†ç­–ç•¥æ›´æ–°ï¼‰

---

## ğŸŠ ç³»ç»ŸçŠ¶æ€

âœ… **å®Œå…¨å®ç°** - æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•  
âœ… **ç”Ÿäº§å°±ç»ª** - ä»£ç æ— é”™è¯¯ï¼Œæ€§èƒ½å¯æ¥å—  
âœ… **æ–‡æ¡£å®Œå–„** - ä½¿ç”¨æ‰‹å†Œå’ŒæŠ€æœ¯æ–‡æ¡£é½å…¨  
âœ… **å‚ç…§æœ€ä½³å®è·µ** - å®Œå…¨éµå¾ª aks-management å®ç°  

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„](./é¡¹ç›®æ¶æ„.md)
- [æ•°æ®åº“ç®¡ç†](./æ•°æ®åº“ç®¡ç†.md)
- [å®‰è£…é…ç½®](./å®‰è£…é…ç½®.md)
- [è°ƒåº¦æ‰§è¡Œè¯´æ˜](./è°ƒåº¦æ‰§è¡Œè¯´æ˜.md)

---

**æ›´æ–°æ—¶é—´:** 2025-10-15  
**ç‰ˆæœ¬:** 1.0.0  
**çŠ¶æ€:** âœ… å·²å®Œæˆ
