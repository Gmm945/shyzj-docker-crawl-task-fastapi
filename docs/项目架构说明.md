# 项目架构说明

## 架构概述

本项目采用模块化架构设计，参照 AKS 项目的结构模式，实现了清晰的职责分离和良好的可维护性。

## 项目结构

```
src/
├── common/                    # 通用模块
│   └── schemas/              # 通用数据模型
├── config/                   # 配置模块
├── db_util/                  # 数据库工具
├── data_platform_api/        # 主业务模块
│   ├── models/               # 业务模型
│   ├── schemas/              # 业务数据模型
│   ├── routes/               # API 路由
│   └── service/              # 业务逻辑
├── user_manage/              # 用户管理模块
│   ├── models/               # 用户模型
│   ├── schemas/              # 用户数据模型
│   ├── routes/               # 用户API路由
│   └── service/              # 用户业务逻辑
├── worker/                   # 异步任务模块
│   ├── main.py               # 任务入口文件（导入所有任务模块）
│   ├── data_collection_tasks.py  # 数据采集任务
│   ├── docker_management_tasks.py # Docker 容器管理任务
│   ├── monitoring_tasks.py   # 监控和清理任务
│   ├── scheduler_tasks.py    # 调度任务
│   ├── db_tasks.py           # 数据库任务
│   ├── file_tasks.py         # 文件处理任务
│   └── utils/                # 任务工具类
├── utils/                    # 通用工具
└── main.py                   # 应用入口
```

## 核心模块

### 1. 数据平台API模块 (`data_platform_api/`)
- **功能**: 核心业务逻辑和API接口
- **包含**: 任务管理、数据采集、API路由
- **特点**: 统一的业务模型和数据处理

### 2. 用户管理模块 (`user_manage/`)
- **功能**: 用户认证、权限管理
- **包含**: 用户模型、认证逻辑、用户API
- **特点**: 独立的用户管理，支持JWT认证

### 3. 异步任务模块 (`worker/`)
- **功能**: 后台任务处理
- **包含**: 数据采集、Docker管理、监控清理、调度器、数据库操作、文件处理
- **特点**: 按功能分类组织任务，支持多种任务类型，实时进度跟踪，统一的任务管理
- **结构**: 
  - `main.py`: 任务入口文件，导入所有任务模块
  - `data_collection_tasks.py`: 数据采集相关任务
  - `docker_management_tasks.py`: Docker 容器管理任务
  - `monitoring_tasks.py`: 监控和清理任务
  - `scheduler_tasks.py`: 调度任务

### 4. 通用模块 (`common/`)
- **功能**: 共享的数据模型和工具
- **包含**: 基础响应模型、分页模型
- **特点**: 跨模块复用的通用组件

## 技术特点

### 数据库设计
- **ORM**: SQLAlchemy 2.0
- **主键**: UUID 类型
- **软删除**: 使用 `is_delete` 字段
- **关系**: 手动 JOIN 查询，避免 N+1 问题

### 异步处理
- **任务队列**: Celery + Redis
- **进度跟踪**: 基于 Redis 的实时进度
- **调度器**: 支持定时和周期性任务
- **容器管理**: Docker 容器的启动、监控、清理

### API设计
- **框架**: FastAPI
- **认证**: JWT Token
- **文档**: 自动生成 Swagger 文档
- **验证**: Pydantic 数据验证

## 开发规范

### 代码组织
- 每个模块包含 `models`、`schemas`、`routes`、`service`
- 使用类型注解和文档字符串
- 统一的错误处理和日志记录

### 数据库操作
- 使用异步数据库会话
- 统一的查询和更新方法
- 适当的索引和约束

### 任务处理
- 支持进度跟踪和错误处理
- 自动资源清理
- 可配置的重试机制

## 扩展指南

### 添加新功能
1. 在对应模块下创建新的路由、服务或模型
2. 更新 API 文档
3. 添加相应的测试

### 添加新任务类型
1. 在 `worker/` 目录下添加新的任务函数
2. 在 `worker/celeryconfig.py` 中配置队列路由
3. 在 `celery_beat_schedule.py` 中添加定时配置

### 数据库迁移
```bash
# 创建迁移文件
pdm run db-revision "描述信息"

# 执行迁移
pdm run db-upgrade
```

## 部署架构

### 服务组件
- **API服务**: FastAPI 应用
- **Worker服务**: Celery 任务处理器
- **调度器**: Celery Beat 定时任务
- **数据库**: MySQL 数据存储
- **缓存**: Redis 缓存和消息队列

### 环境配置
- **开发环境**: 本地开发配置
- **测试环境**: 自动化测试配置
- **生产环境**: 高可用生产配置

## 监控和维护

### 健康检查
- API 服务健康状态
- 数据库连接状态
- Redis 连接状态
- 任务队列状态

### 日志管理
- 应用日志记录
- 错误日志跟踪
- 性能指标监控

### 备份策略
- 数据库定期备份
- 配置文件版本控制
- 日志文件轮转

## 总结

本架构设计具有以下优势：

1. **模块化** - 清晰的职责分离
2. **可扩展** - 易于添加新功能
3. **可维护** - 统一的代码规范
4. **高性能** - 异步处理和缓存优化
5. **可监控** - 完善的日志和健康检查

通过这种架构设计，项目能够支持快速开发、稳定运行和持续演进。
