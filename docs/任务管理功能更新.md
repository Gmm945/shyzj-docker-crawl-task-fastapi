# 任务管理功能更新说明

## 更新内容

### 1. 任务列表显示增强

任务列表现在显示以下额外信息：

- **触发方式**：手动(manual) / 自动(auto)
- **执行统计**：
  - 总执行次数
  - 成功次数
  - 失败次数
  - 最后一次执行状态
  - 最后一次执行时间
  - 下次执行时间（仅自动任务）

### 2. 任务触发方式控制

- 通过 `trigger_method` 字段明确指定任务模式：`manual`（手动）或 `auto`（自动）
- 手动任务：只能通过API接口手动触发执行，不需要调度配置
- 自动任务：必须提供调度配置，通过调度配置自动执行

### 3. 动态调度配置

- **一个任务只能绑定一个调度**：每个任务同时只能有一个调度配置
- 支持在线修改任务的定时配置，无需重启服务即可生效
- 修改调度类型（如从小时改为分钟）立即生效
- 任务从自动模式改为手动模式时，自动禁用相关调度
- 重复创建调度时，系统会自动更新现有调度而不是创建新的

### 4. 任务状态控制

- 停用任务时，自动任务和手动任务都不执行
- 只有激活状态的任务才能被手动执行
- 调度器只执行激活状态的任务

### 5. 移除重试逻辑

- 任务执行失败就是失败，不再进行自动重试
- 移除了连续失败3次自动禁用调度的逻辑
- 移除了任务失败后自动暂停的逻辑

## API接口变更

### 新增字段

#### TaskCreate
```json
{
  "task_name": "任务名称",
  "task_type": "api",
  "trigger_method": "manual" | "auto",
  "schedule_type": "hourly" | "daily" | "weekly" | "monthly" | "minutely",
  "schedule_config": {
    "interval": 2,
    "time": "10:00:00"
  }
}
```

#### TaskUpdate
```json
{
  "trigger_method": "manual" | "auto"
}
```

#### TaskResponse
```json
{
  "trigger_method": "manual" | "auto",
  "execution_summary": {
    "total_executions": 0,
    "success_count": 0,
    "failed_count": 0,
    "last_execution_status": "success",
    "last_execution_time": "2024-01-01T10:00:00",
    "next_execution_time": "2024-01-01T11:00:00"
  }
}
```

### 新增接口

#### 更新调度配置
```
PUT /api/v1/scheduler/{schedule_id}
```

## 数据库变更

### 新增字段
```sql
ALTER TABLE tasks ADD COLUMN trigger_method VARCHAR(20) DEFAULT 'manual' COMMENT '触发方式：manual-手动，auto-自动';
```

### 迁移脚本
执行 `scripts/add_trigger_method_field.sql` 来更新现有数据。

## 使用说明

### 创建自动任务
1. 创建任务时设置 `trigger_method: "auto"`
2. 必须同时提供 `schedule_type` 和 `schedule_config` 参数
3. 系统会自动创建调度配置
4. 任务将按照调度配置自动执行

### 创建手动任务
1. 创建任务时设置 `trigger_method: "manual"`（默认值）
2. 不需要提供调度配置参数
3. 只能通过API接口手动触发执行

### 修改任务触发方式
1. 通过任务更新接口修改 `trigger_method`
2. 从自动改为手动时，系统会自动禁用相关调度
3. 从手动改为自动时，需要手动创建调度配置

### 调度配置管理
1. **创建任务时同时创建调度**：在创建任务时提供 `schedule_type` 和 `schedule_config` 参数
2. **单独创建调度**：为任务创建调度配置，如果任务已有调度则自动更新
3. **更新调度**：通过调度更新接口修改现有调度配置
4. **启用/禁用调度**：通过toggle接口控制调度是否生效
5. **删除调度**：删除任务的调度配置（任务变为手动模式）

### 动态修改调度配置
1. 通过调度更新接口修改调度配置
2. 修改后立即生效，无需重启服务
3. 下次执行时间会自动重新计算

## 注意事项

1. **权限控制**：只有任务创建者或管理员可以修改任务配置
2. **状态检查**：停用的任务无法执行，无论是手动还是自动触发
3. **调度依赖**：自动任务需要有效的调度配置才能正常执行
4. **失败处理**：任务失败后不会自动重试，需要手动重新执行或检查问题
5. **单一调度**：每个任务只能有一个调度配置，重复创建会自动更新现有配置
6. **调度查询**：获取任务调度时只返回最新的一个配置
7. **参数验证**：自动任务必须提供调度配置，手动任务不需要调度配置
8. **模式切换**：从自动改为手动时自动禁用调度，从手动改为自动时需要创建调度

## 兼容性

- 现有API接口保持兼容
- 新增字段都有默认值
- 现有任务功能不受影响
- 建议逐步迁移到新的触发方式控制
