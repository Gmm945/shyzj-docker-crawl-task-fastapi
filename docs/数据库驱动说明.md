# æ•°æ®åº“é©±åŠ¨è¯´æ˜

## å½“å‰é…ç½®

### å¼‚æ­¥é©±åŠ¨ï¼šasyncmy

æœ¬é¡¹ç›®ä½¿ç”¨ **asyncmy** ä½œä¸º MySQL å¼‚æ­¥é©±åŠ¨ã€‚

**è¿æ¥å­—ç¬¦ä¸²ï¼š**
```
mysql+asyncmy://user:password@host:port/database
```

**ä¾èµ–ï¼š**
- `asyncmy>=0.2.10`
- `greenlet`

---

## ç‰¹ç‚¹è¯´æ˜

### âœ… ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜ç§€**
   - æ¯” aiomysql æ€§èƒ½æ›´å¥½
   - ä¸“ä¸ºé«˜å¹¶å‘è®¾è®¡

2. **ç°ä»£åŒ–**
   - ç»´æŠ¤æ´»è·ƒ
   - ä¸ SQLAlchemy 2.0 å®Œç¾å…¼å®¹

3. **åŠŸèƒ½å®Œæ•´**
   - æ”¯æŒæ‰€æœ‰ MySQL ç‰¹æ€§
   - ä¸ FastAPI é›†æˆè‰¯å¥½

### âš ï¸ æ³¨æ„äº‹é¡¹

#### å¯åŠ¨é¢„çƒ­æœŸ

**ç°è±¡ï¼š**
- æœåŠ¡å¯åŠ¨å **å‰ 15-20 ç§’**ï¼Œéƒ¨åˆ†è¯·æ±‚å¯èƒ½å¤±è´¥
- é”™è¯¯ï¼š`Task got Future attached to a different loop`

**åŸå› ï¼š**
- æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–éœ€è¦æ—¶é—´
- å¼‚æ­¥äº‹ä»¶å¾ªç¯é¢„çƒ­

**è§£å†³æ–¹æ¡ˆï¼š**
1. **ç”Ÿäº§ç¯å¢ƒ**ï¼š
   - é…ç½®å¥åº·æ£€æŸ¥å»¶è¿Ÿå¯åŠ¨ï¼ˆreadiness probe delayï¼‰
   - Kubernetes: `initialDelaySeconds: 20`
   - Docker Compose: `healthcheck.start_period: 20s`

2. **å¼€å‘ç¯å¢ƒ**ï¼š
   - ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆçœ‹åˆ° "Application startup complete"ï¼‰
   - ç­‰å¾… 15-20 ç§’åå†è°ƒç”¨ API

3. **API è°ƒç”¨ç«¯**ï¼š
   - æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆæ¨è 3 æ¬¡ï¼Œé—´éš” 2 ç§’ï¼‰

---

## ä½¿ç”¨å»ºè®®

### å¥åº·æ£€æŸ¥é…ç½®

#### Docker Compose
```yaml
services:
  api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/api/v1/common/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s  # â­ é‡è¦ï¼šå¯åŠ¨é¢„çƒ­æœŸ
```

#### Kubernetes
```yaml
livenessProbe:
  httpGet:
    path: /api/v1/common/health/liveness
    port: 8089
  initialDelaySeconds: 20  # â­ é‡è¦ï¼šå¯åŠ¨å»¶è¿Ÿ
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /api/v1/common/health/readiness
    port: 8089
  initialDelaySeconds: 20  # â­ é‡è¦ï¼šå¯åŠ¨å»¶è¿Ÿ
  periodSeconds: 5
```

### å®¢æˆ·ç«¯é‡è¯•ç¤ºä¾‹

```python
import httpx
import time

async def call_api_with_retry(url, max_retries=3):
    """API è°ƒç”¨å¸¦é‡è¯•"""
    for i in range(max_retries):
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(url, ...)
                return response.json()
        except Exception as e:
            if i < max_retries - 1:
                await asyncio.sleep(2)  # ç­‰å¾… 2 ç§’åé‡è¯•
                continue
            raise
```

---

## æ€§èƒ½ä¼˜åŒ–

### è¿æ¥æ± é…ç½®

å½“å‰é…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰ï¼š
```python
DATABASE_POOL_SIZE = 20        # è¿æ¥æ± å¤§å°
DATABASE_MAX_OVERFLOW = 30     # æœ€å¤§æº¢å‡ºè¿æ¥
DATABASE_POOL_TIMEOUT = 60     # è·å–è¿æ¥è¶…æ—¶
DATABASE_POOL_RECYCLE = 1800   # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
```

**è¯´æ˜ï¼š**
- å·²ç§»é™¤ `pool_pre_ping`ï¼ˆé¿å…äº‹ä»¶å¾ªç¯å†²çªï¼‰
- é€‚åˆä¸­ç­‰å¹¶å‘é‡ï¼ˆ100-200 QPSï¼‰

---

## æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœé‡åˆ°æ— æ³•æ¥å—çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### æ–¹æ¡ˆ 1: mysql-connector-pythonï¼ˆå®˜æ–¹ï¼‰
```bash
pdm remove asyncmy
pdm add mysql-connector-python

# ä¿®æ”¹è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL = "mysql+mysqlconnector://..."
```

**ä¼˜ç‚¹ï¼š** å®˜æ–¹ç»´æŠ¤ï¼Œç¨³å®šæ€§æœ€å¥½  
**ç¼ºç‚¹ï¼š** æ€§èƒ½ç•¥é€Šäº asyncmy

### æ–¹æ¡ˆ 2: Tortoise ORMï¼ˆå®Œå…¨ä¸åŒï¼‰
```bash
pdm add tortoise-orm
```

**ä¼˜ç‚¹ï¼š** åŸç”Ÿå¼‚æ­¥ï¼Œæ— äº‹ä»¶å¾ªç¯é—®é¢˜  
**ç¼ºç‚¹ï¼š** éœ€è¦é‡å†™æ‰€æœ‰ä»£ç 

---

## ç›‘æ§å»ºè®®

### 1. å¯åŠ¨å¥åº·æ£€æŸ¥

ä½¿ç”¨æä¾›çš„è„šæœ¬ç­‰å¾…æœåŠ¡å°±ç»ªï¼š
```bash
# è‡ªåŠ¨ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆåŒ…å«æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–ï¼‰
bash scripts/wait_for_ready.sh

# æˆ–æ‰‹åŠ¨ç­‰å¾…
while ! curl -f http://localhost:8089/api/v1/common/health; do
    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    sleep 2
done
sleep 15  # é¢å¤–ç­‰å¾…æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–
echo "âœ… æœåŠ¡å·²å°±ç»ª"
```

### 2. è¿æ¥æ± ç›‘æ§
åœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- è¿æ¥æ± ä½¿ç”¨ç‡
- è¿æ¥è·å–è¶…æ—¶æ¬¡æ•°
- æ•°æ®åº“æŸ¥è¯¢è€—æ—¶

---

## å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒ
```bash
# 1. å¯åŠ¨æœåŠ¡
pdm run start

# 2. ç­‰å¾… 20 ç§’
sleep 20

# 3. å¼€å§‹ä½¿ç”¨ API
curl http://localhost:8089/api/v1/docs
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨ Docker Composeï¼ˆå·²é…ç½®å¥åº·æ£€æŸ¥ï¼‰
docker-compose up -d

# æˆ–ä½¿ç”¨ Kubernetesï¼ˆå·²é…ç½® readiness probeï¼‰
kubectl apply -f deployment.yaml
```

---

## æ€»ç»“

âœ… **asyncmy æ˜¯å½“å‰æœ€ä½³é€‰æ‹©**
- æ€§èƒ½å¥½
- ä¸ SQLAlchemy å…¼å®¹
- ç»´æŠ¤æ´»è·ƒ

âš ï¸ **éœ€è¦æ³¨æ„å¯åŠ¨é¢„çƒ­æœŸ**
- é…ç½®å¥åº·æ£€æŸ¥å»¶è¿Ÿ
- å®¢æˆ·ç«¯æ·»åŠ é‡è¯•
- ç­‰å¾… 15-20 ç§’åæœåŠ¡å®Œå…¨ç¨³å®š

ğŸ“ **ç›‘æ§è¦ç‚¹**
- å…³æ³¨è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
- ç›‘æ§å¯åŠ¨æ—¶é—´
- è®°å½•å¼‚å¸¸è¯·æ±‚

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-10-15  
**é©±åŠ¨ç‰ˆæœ¬ï¼š** asyncmy 0.2.10

