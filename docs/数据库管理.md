# 数据库管理指南

## 概述

本项目使用**SQLAlchemy ORM**进行数据库管理，提供统一的数据库操作、自动表创建、模型驱动等功能。基于纯ORM方式，无需手动SQL脚本。

## 核心特性

### ✨ ORM驱动
- 基于SQLAlchemy模型自动创建表结构
- 模型变更自动同步到数据库
- 无需维护SQL脚本或迁移文件
- 支持模型级别的数据验证

### 🔒 安全操作
- 重置前需要用户确认
- 完善的错误处理和日志输出
- 操作后自动验证结果
- 基于事务的原子操作

### 📊 完整支持
- 支持全新安装
- 支持现有系统升级
- 支持模型驱动的表结构管理
- 支持默认数据插入

## 使用方法

### 推荐命令（PDM方式）

```bash
# 初始化数据库（全新安装）
pdm run db:init

# 升级数据库（现有系统）
pdm run db:upgrade

# 查看数据库状态
pdm run db:status

# 重置数据库（开发环境）
pdm run db:reset
```

### 直接命令方式

```bash
# 使用统一管理工具
python scripts/db_manager.py init
python scripts/db_manager.py upgrade
python scripts/db_manager.py status
python scripts/db_manager.py reset
```

## 数据库模型

### 核心模型

| 模型 | 表名 | 说明 |
|------|------|------|
| `User` | `users` | 用户信息 |
| `Task` | `tasks` | 任务配置 |
| `TaskExecution` | `task_executions` | 任务执行记录 |
| `TaskSchedule` | `task_schedules` | 任务调度配置 |

### 字段类型

所有模型使用字符串类型字段，避免枚举复杂性：

| 字段类型 | 数据库类型 | 说明 | 示例 |
|----------|------------|------|------|
| 任务类型 | VARCHAR(50) | 任务类型 | `docker-crawl`, `api`, `database` |
| 任务状态 | VARCHAR(50) | 任务状态 | `active`, `paused`, `running` |
| 执行状态 | VARCHAR(50) | 执行状态 | `pending`, `running`, `success`, `failed` |
| 调度类型 | VARCHAR(50) | 调度类型 | `immediate`, `scheduled`, `weekly` |

### Docker相关字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `docker_container_name` | VARCHAR(64) | 容器名 | `task-12345678-1234-1234-1234-123456789abc` |
| `docker_container_id` | VARCHAR(64) | 容器ID | `c440cd245385cffac9987ff1ec14c04274dda851ed231e2f781979840eca46c5` |
| `docker_command` | TEXT | 执行命令 | `docker run -d --name task-123...` |
| `docker_port` | INT | 端口号 | `50001` |

## 使用场景

### 1. 全新安装

```bash
# 1. 克隆项目
git clone <repository>
cd shyzj-docker-crawl-task-fastapi

# 2. 安装依赖
pdm install

# 3. 初始化数据库（自动创建所有表）
pdm run db:init

# 4. 启动服务
pdm run start
pdm run celery:worker
pdm run celery:beat
```

### 2. 现有系统升级

```bash
# 1. 查看当前状态
pdm run db:status

# 2. 执行升级（自动同步模型变更）
pdm run db:upgrade

# 3. 验证升级结果
pdm run db:status
```

### 3. 开发环境重置

```bash
# 重置数据库（会删除所有数据，需要确认）
pdm run db:reset
```

### 4. 生产环境部署

```bash
# 1. 备份数据库
mysqldump -u root -p data_platform > backup.sql

# 2. 执行升级
pdm run db:upgrade

# 3. 验证升级
pdm run db:status
```

## 技术架构

### 1. 模型定义

```python
# src/data_platform_api/models/task.py
class Task(BaseModel):
    __tablename__ = "tasks"
    
    task_name = Column(String(200), nullable=False, comment="任务名称")
    task_type = Column(String(50), nullable=False, comment="任务类型")
    status = Column(String(50), default="active", comment="任务状态")
    # ... 其他字段

# src/user_manage/models/user.py  
class User(BaseModel):
    __tablename__ = "users"
    
    username = Column(String(50), unique=True, nullable=False, comment="用户名")
    email = Column(String(100), unique=True, nullable=False, comment="邮箱")
    # ... 其他字段
```

### 2. 自动表创建

```python
# scripts/db_manager.py
def init_database(self) -> bool:
    # 使用SQLAlchemy创建所有表
    BaseModel.metadata.create_all(self.engine)
    
    # 插入默认数据
    self._insert_default_data()
```

### 3. 环境配置

数据库配置通过`.env`文件管理：

```bash
# .env
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=data_platform
```

## 技术优势

### 1. 简化架构

- **ORM驱动**: 基于SQLAlchemy模型，无需手动SQL
- **自动同步**: 模型变更自动反映到数据库
- **无迁移文件**: 不需要维护复杂的迁移文件
- **环境配置**: 支持从.env文件读取配置

### 2. 开发效率

- **模型优先**: 先定义模型，自动生成表结构
- **类型安全**: 基于Python类型，减少错误
- **自动验证**: 模型级别的数据验证
- **快速迭代**: 修改模型即可自动更新数据库

### 3. 易于维护

- **直观易懂**: 基于Python模型，更容易理解
- **灵活修改**: 可以任意修改模型结构
- **简单调试**: 问题更容易定位和解决
- **版本控制**: 模型变更通过Git管理

### 4. 无外键约束

- **简化结构**: 移除外键约束，减少复杂性
- **提高性能**: 避免外键检查的开销
- **易于扩展**: 更容易进行数据库扩展
- **灵活操作**: 不受外键约束限制

## 对比分析

### 迁移前后对比

| 方面 | 迁移前（SQL脚本） | 迁移后（SQLAlchemy ORM） |
|------|------------------|-------------------------|
| 表创建方式 | 手动SQL脚本 | 模型自动创建 |
| 字段管理 | 手动ALTER TABLE | 模型自动同步 |
| 数据验证 | 数据库级别 | 模型级别 |
| 维护成本 | 高（维护SQL） | 低（维护模型） |
| 类型安全 | 无 | 有（Python类型） |
| 开发效率 | 低 | 高 |

### 功能对比

| 功能 | SQL脚本版本 | ORM版本 |
|------|-------------|---------|
| 数据库初始化 | ✅ | ✅ |
| 字段添加 | ✅ | ✅ |
| 表结构升级 | ✅ | ✅ |
| 数据验证 | ❌ | ✅ |
| 类型安全 | ❌ | ✅ |
| 自动同步 | ❌ | ✅ |
| 维护成本 | 高 | 低 |

## 故障排除

### 常见问题

1. **MySQL连接失败**
   ```bash
   # 检查MySQL服务状态
   docker ps | grep mysql
   
   # 启动MySQL服务
   docker start mysql80
   ```

2. **模型导入错误**
   ```bash
   # 确保所有模型都被正确导入
   python -c "from src.data_platform_api.models.base import BaseModel; print('导入成功')"
   ```

3. **表结构不一致**
   ```bash
   # 重新同步模型到数据库
   pdm run db:reset
   ```

### 回滚操作

如果需要回滚到SQL脚本版本：

```bash
# 1. 备份当前数据
mysqldump -u root -p data_platform > backup.sql

# 2. 重置数据库
pdm run db:reset

# 3. 恢复数据（如果需要）
mysql -u root -p data_platform < backup.sql
```

## 最佳实践

### 1. 开发环境

- 使用 `pdm run db:init` 进行初始化
- 使用 `pdm run db:status` 查看状态
- 使用 `pdm run db:reset` 重置环境
- 修改模型后使用 `pdm run db:upgrade` 同步

### 2. 生产环境

- 使用 `pdm run db:upgrade` 进行升级
- 升级前先备份数据库
- 在测试环境验证后再部署
- 监控数据库连接状态

### 3. 模型设计

- 保持模型结构简单清晰
- 使用有意义的字段名和注释
- 避免复杂的关联关系
- 优先使用字符串类型而非枚举

### 4. 版本控制

- 所有模型变更都通过Git管理
- 模型文件需要提交到版本控制
- 避免直接修改数据库结构
- 使用有意义的提交信息

## 字段变更记录

### v3.0 (2025-09-24)

#### 架构变更
- 完全移除SQL脚本依赖
- 改为基于SQLAlchemy ORM的模型驱动
- 移除所有外键约束
- 统一使用字符串类型字段

#### 模型结构
- `User` 模型：继承 `BaseModel`，包含用户基本信息
- `Task` 模型：任务配置，使用字符串类型状态字段
- `TaskExecution` 模型：执行记录，包含Docker相关信息
- `TaskSchedule` 模型：调度配置

#### 优势
1. **模型驱动**: 基于Python模型，类型安全
2. **自动同步**: 模型变更自动同步到数据库
3. **简化维护**: 无需维护SQL脚本
4. **开发效率**: 更快的开发和迭代速度

## 总结

通过这次完全重构，我们实现了：

1. **🎯 模型驱动**: 基于SQLAlchemy ORM，模型即数据库
2. **📦 零SQL依赖**: 完全移除SQL脚本，纯ORM方式
3. **🔧 自动同步**: 模型变更自动同步到数据库
4. **🚀 类型安全**: 基于Python类型，减少运行时错误
5. **💡 开发友好**: 更直观的模型定义和操作
6. **🔄 简化维护**: 无需维护复杂的SQL脚本

现在的数据库管理方案是最现代化、最开发友好的版本！

## 命令速查表

| 操作 | 命令 | 说明 |
|------|------|------|
| 初始化 | `pdm run db:init` | 基于模型创建所有表 |
| 升级 | `pdm run db:upgrade` | 同步模型变更到数据库 |
| 状态 | `pdm run db:status` | 查看数据库和表状态 |
| 重置 | `pdm run db:reset` | 重置数据库（开发用） |

## 相关文档

- [项目架构](./项目架构.md) - 了解整体架构
- [安装配置](./安装配置.md) - 环境配置指南
- [任务执行](./任务执行.md) - 任务执行流程