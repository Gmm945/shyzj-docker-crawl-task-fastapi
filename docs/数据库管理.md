# æ•°æ®åº“ç®¡ç†æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨**SQLAlchemy ORM**è¿›è¡Œæ•°æ®åº“ç®¡ç†ï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œã€è‡ªåŠ¨è¡¨åˆ›å»ºã€æ¨¡å‹é©±åŠ¨ç­‰åŠŸèƒ½ã€‚åŸºäºçº¯ORMæ–¹å¼ï¼Œæ— éœ€æ‰‹åŠ¨SQLè„šæœ¬ã€‚

## æ ¸å¿ƒç‰¹æ€§

### âœ¨ ORMé©±åŠ¨
- åŸºäºSQLAlchemyæ¨¡å‹è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- æ¨¡å‹å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- æ— éœ€ç»´æŠ¤SQLè„šæœ¬æˆ–è¿ç§»æ–‡ä»¶
- æ”¯æŒæ¨¡å‹çº§åˆ«çš„æ•°æ®éªŒè¯

### ğŸ”’ å®‰å…¨æ“ä½œ
- é‡ç½®å‰éœ€è¦ç”¨æˆ·ç¡®è®¤
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
- æ“ä½œåè‡ªåŠ¨éªŒè¯ç»“æœ
- åŸºäºäº‹åŠ¡çš„åŸå­æ“ä½œ

### ğŸ“Š å®Œæ•´æ”¯æŒ
- æ”¯æŒå…¨æ–°å®‰è£…
- æ”¯æŒç°æœ‰ç³»ç»Ÿå‡çº§
- æ”¯æŒæ¨¡å‹é©±åŠ¨çš„è¡¨ç»“æ„ç®¡ç†
- æ”¯æŒé»˜è®¤æ•°æ®æ’å…¥

## ä½¿ç”¨æ–¹æ³•

### æ¨èå‘½ä»¤ï¼ˆPDMæ–¹å¼ï¼‰

```bash
# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå…¨æ–°å®‰è£…ï¼‰
pdm run db:init

# å‡çº§æ•°æ®åº“ï¼ˆç°æœ‰ç³»ç»Ÿï¼‰
pdm run db:upgrade

# æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
pdm run db:status

# é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
pdm run db:reset
```

### ç›´æ¥å‘½ä»¤æ–¹å¼

```bash
# ä½¿ç”¨ç»Ÿä¸€ç®¡ç†å·¥å…·
python scripts/db_manager.py init
python scripts/db_manager.py upgrade
python scripts/db_manager.py status
python scripts/db_manager.py reset
```

## æ•°æ®åº“æ¨¡å‹

### æ ¸å¿ƒæ¨¡å‹

| æ¨¡å‹ | è¡¨å | è¯´æ˜ |
|------|------|------|
| `User` | `users` | ç”¨æˆ·ä¿¡æ¯ |
| `Task` | `tasks` | ä»»åŠ¡é…ç½® |
| `TaskExecution` | `task_executions` | ä»»åŠ¡æ‰§è¡Œè®°å½• |
| `TaskSchedule` | `task_schedules` | ä»»åŠ¡è°ƒåº¦é…ç½® |

### å­—æ®µç±»å‹

æ‰€æœ‰æ¨¡å‹ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹å­—æ®µï¼Œé¿å…æšä¸¾å¤æ‚æ€§ï¼š

| å­—æ®µç±»å‹ | æ•°æ®åº“ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|------------|------|------|
| ä»»åŠ¡ç±»å‹ | VARCHAR(50) | ä»»åŠ¡ç±»å‹ | `docker-crawl`, `api`, `database` |
| ä»»åŠ¡çŠ¶æ€ | VARCHAR(50) | ä»»åŠ¡çŠ¶æ€ | `active`, `paused`, `running` |
| æ‰§è¡ŒçŠ¶æ€ | VARCHAR(50) | æ‰§è¡ŒçŠ¶æ€ | `pending`, `running`, `success`, `failed` |
| è°ƒåº¦ç±»å‹ | VARCHAR(50) | è°ƒåº¦ç±»å‹ | `immediate`, `scheduled`, `weekly` |

### Dockerç›¸å…³å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `docker_container_name` | VARCHAR(64) | å®¹å™¨å | `task-12345678-1234-1234-1234-123456789abc` |
| `docker_container_id` | VARCHAR(64) | å®¹å™¨ID | `c440cd245385cffac9987ff1ec14c04274dda851ed231e2f781979840eca46c5` |
| `docker_command` | TEXT | æ‰§è¡Œå‘½ä»¤ | `docker run -d --name task-123...` |
| `docker_port` | INT | ç«¯å£å· | `50001` |

## ä½¿ç”¨åœºæ™¯

### 1. å…¨æ–°å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository>
cd shyzj-docker-crawl-task-fastapi

# 2. å®‰è£…ä¾èµ–
pdm install

# 3. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨ï¼‰
pdm run db:init

# 4. å¯åŠ¨æœåŠ¡
pdm run start
pdm run celery:worker
pdm run celery:beat
```

### 2. ç°æœ‰ç³»ç»Ÿå‡çº§

```bash
# 1. æŸ¥çœ‹å½“å‰çŠ¶æ€
pdm run db:status

# 2. æ‰§è¡Œå‡çº§ï¼ˆè‡ªåŠ¨åŒæ­¥æ¨¡å‹å˜æ›´ï¼‰
pdm run db:upgrade

# 3. éªŒè¯å‡çº§ç»“æœ
pdm run db:status
```

### 3. å¼€å‘ç¯å¢ƒé‡ç½®

```bash
# é‡ç½®æ•°æ®åº“ï¼ˆä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦ç¡®è®¤ï¼‰
pdm run db:reset
```

### 4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p data_platform > backup.sql

# 2. æ‰§è¡Œå‡çº§
pdm run db:upgrade

# 3. éªŒè¯å‡çº§
pdm run db:status
```

## æŠ€æœ¯æ¶æ„

### 1. æ¨¡å‹å®šä¹‰

```python
# src/data_platform_api/models/task.py
class Task(BaseModel):
    __tablename__ = "tasks"
    
    task_name = Column(String(200), nullable=False, comment="ä»»åŠ¡åç§°")
    task_type = Column(String(50), nullable=False, comment="ä»»åŠ¡ç±»å‹")
    status = Column(String(50), default="active", comment="ä»»åŠ¡çŠ¶æ€")
    # ... å…¶ä»–å­—æ®µ

# src/user_manage/models/user.py  
class User(BaseModel):
    __tablename__ = "users"
    
    username = Column(String(50), unique=True, nullable=False, comment="ç”¨æˆ·å")
    email = Column(String(100), unique=True, nullable=False, comment="é‚®ç®±")
    # ... å…¶ä»–å­—æ®µ
```

### 2. è‡ªåŠ¨è¡¨åˆ›å»º

```python
# scripts/db_manager.py
def init_database(self) -> bool:
    # ä½¿ç”¨SQLAlchemyåˆ›å»ºæ‰€æœ‰è¡¨
    BaseModel.metadata.create_all(self.engine)
    
    # æ’å…¥é»˜è®¤æ•°æ®
    self._insert_default_data()
```

### 3. ç¯å¢ƒé…ç½®

æ•°æ®åº“é…ç½®é€šè¿‡`.env`æ–‡ä»¶ç®¡ç†ï¼š

```bash
# .env
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=data_platform
```

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ç®€åŒ–æ¶æ„

- **ORMé©±åŠ¨**: åŸºäºSQLAlchemyæ¨¡å‹ï¼Œæ— éœ€æ‰‹åŠ¨SQL
- **è‡ªåŠ¨åŒæ­¥**: æ¨¡å‹å˜æ›´è‡ªåŠ¨åæ˜ åˆ°æ•°æ®åº“
- **æ— è¿ç§»æ–‡ä»¶**: ä¸éœ€è¦ç»´æŠ¤å¤æ‚çš„è¿ç§»æ–‡ä»¶
- **ç¯å¢ƒé…ç½®**: æ”¯æŒä».envæ–‡ä»¶è¯»å–é…ç½®

### 2. å¼€å‘æ•ˆç‡

- **æ¨¡å‹ä¼˜å…ˆ**: å…ˆå®šä¹‰æ¨¡å‹ï¼Œè‡ªåŠ¨ç”Ÿæˆè¡¨ç»“æ„
- **ç±»å‹å®‰å…¨**: åŸºäºPythonç±»å‹ï¼Œå‡å°‘é”™è¯¯
- **è‡ªåŠ¨éªŒè¯**: æ¨¡å‹çº§åˆ«çš„æ•°æ®éªŒè¯
- **å¿«é€Ÿè¿­ä»£**: ä¿®æ”¹æ¨¡å‹å³å¯è‡ªåŠ¨æ›´æ–°æ•°æ®åº“

### 3. æ˜“äºç»´æŠ¤

- **ç›´è§‚æ˜“æ‡‚**: åŸºäºPythonæ¨¡å‹ï¼Œæ›´å®¹æ˜“ç†è§£
- **çµæ´»ä¿®æ”¹**: å¯ä»¥ä»»æ„ä¿®æ”¹æ¨¡å‹ç»“æ„
- **ç®€å•è°ƒè¯•**: é—®é¢˜æ›´å®¹æ˜“å®šä½å’Œè§£å†³
- **ç‰ˆæœ¬æ§åˆ¶**: æ¨¡å‹å˜æ›´é€šè¿‡Gitç®¡ç†

### 4. æ— å¤–é”®çº¦æŸ

- **ç®€åŒ–ç»“æ„**: ç§»é™¤å¤–é”®çº¦æŸï¼Œå‡å°‘å¤æ‚æ€§
- **æé«˜æ€§èƒ½**: é¿å…å¤–é”®æ£€æŸ¥çš„å¼€é”€
- **æ˜“äºæ‰©å±•**: æ›´å®¹æ˜“è¿›è¡Œæ•°æ®åº“æ‰©å±•
- **çµæ´»æ“ä½œ**: ä¸å—å¤–é”®çº¦æŸé™åˆ¶

## å¯¹æ¯”åˆ†æ

### è¿ç§»å‰åå¯¹æ¯”

| æ–¹é¢ | è¿ç§»å‰ï¼ˆSQLè„šæœ¬ï¼‰ | è¿ç§»åï¼ˆSQLAlchemy ORMï¼‰ |
|------|------------------|-------------------------|
| è¡¨åˆ›å»ºæ–¹å¼ | æ‰‹åŠ¨SQLè„šæœ¬ | æ¨¡å‹è‡ªåŠ¨åˆ›å»º |
| å­—æ®µç®¡ç† | æ‰‹åŠ¨ALTER TABLE | æ¨¡å‹è‡ªåŠ¨åŒæ­¥ |
| æ•°æ®éªŒè¯ | æ•°æ®åº“çº§åˆ« | æ¨¡å‹çº§åˆ« |
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆç»´æŠ¤SQLï¼‰ | ä½ï¼ˆç»´æŠ¤æ¨¡å‹ï¼‰ |
| ç±»å‹å®‰å…¨ | æ—  | æœ‰ï¼ˆPythonç±»å‹ï¼‰ |
| å¼€å‘æ•ˆç‡ | ä½ | é«˜ |

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | SQLè„šæœ¬ç‰ˆæœ¬ | ORMç‰ˆæœ¬ |
|------|-------------|---------|
| æ•°æ®åº“åˆå§‹åŒ– | âœ… | âœ… |
| å­—æ®µæ·»åŠ  | âœ… | âœ… |
| è¡¨ç»“æ„å‡çº§ | âœ… | âœ… |
| æ•°æ®éªŒè¯ | âŒ | âœ… |
| ç±»å‹å®‰å…¨ | âŒ | âœ… |
| è‡ªåŠ¨åŒæ­¥ | âŒ | âœ… |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ |

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MySQLè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
   docker ps | grep mysql
   
   # å¯åŠ¨MySQLæœåŠ¡
   docker start mysql80
   ```

2. **æ¨¡å‹å¯¼å…¥é”™è¯¯**
   ```bash
   # ç¡®ä¿æ‰€æœ‰æ¨¡å‹éƒ½è¢«æ­£ç¡®å¯¼å…¥
   python -c "from src.data_platform_api.models.base import BaseModel; print('å¯¼å…¥æˆåŠŸ')"
   ```

3. **è¡¨ç»“æ„ä¸ä¸€è‡´**
   ```bash
   # é‡æ–°åŒæ­¥æ¨¡å‹åˆ°æ•°æ®åº“
   pdm run db:reset
   ```

### å›æ»šæ“ä½œ

å¦‚æœéœ€è¦å›æ»šåˆ°SQLè„šæœ¬ç‰ˆæœ¬ï¼š

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®
mysqldump -u root -p data_platform > backup.sql

# 2. é‡ç½®æ•°æ®åº“
pdm run db:reset

# 3. æ¢å¤æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
mysql -u root -p data_platform < backup.sql
```

## æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ

- ä½¿ç”¨ `pdm run db:init` è¿›è¡Œåˆå§‹åŒ–
- ä½¿ç”¨ `pdm run db:status` æŸ¥çœ‹çŠ¶æ€
- ä½¿ç”¨ `pdm run db:reset` é‡ç½®ç¯å¢ƒ
- ä¿®æ”¹æ¨¡å‹åä½¿ç”¨ `pdm run db:upgrade` åŒæ­¥

### 2. ç”Ÿäº§ç¯å¢ƒ

- ä½¿ç”¨ `pdm run db:upgrade` è¿›è¡Œå‡çº§
- å‡çº§å‰å…ˆå¤‡ä»½æ•°æ®åº“
- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²
- ç›‘æ§æ•°æ®åº“è¿æ¥çŠ¶æ€

### 3. æ¨¡å‹è®¾è®¡

- ä¿æŒæ¨¡å‹ç»“æ„ç®€å•æ¸…æ™°
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µåå’Œæ³¨é‡Š
- é¿å…å¤æ‚çš„å…³è”å…³ç³»
- ä¼˜å…ˆä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹è€Œéæšä¸¾

### 4. ç‰ˆæœ¬æ§åˆ¶

- æ‰€æœ‰æ¨¡å‹å˜æ›´éƒ½é€šè¿‡Gitç®¡ç†
- æ¨¡å‹æ–‡ä»¶éœ€è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- é¿å…ç›´æ¥ä¿®æ”¹æ•°æ®åº“ç»“æ„
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯

## å­—æ®µå˜æ›´è®°å½•

### v3.0 (2025-09-24)

#### æ¶æ„å˜æ›´
- å®Œå…¨ç§»é™¤SQLè„šæœ¬ä¾èµ–
- æ”¹ä¸ºåŸºäºSQLAlchemy ORMçš„æ¨¡å‹é©±åŠ¨
- ç§»é™¤æ‰€æœ‰å¤–é”®çº¦æŸ
- ç»Ÿä¸€ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹å­—æ®µ

#### æ¨¡å‹ç»“æ„
- `User` æ¨¡å‹ï¼šç»§æ‰¿ `BaseModel`ï¼ŒåŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- `Task` æ¨¡å‹ï¼šä»»åŠ¡é…ç½®ï¼Œä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹çŠ¶æ€å­—æ®µ
- `TaskExecution` æ¨¡å‹ï¼šæ‰§è¡Œè®°å½•ï¼ŒåŒ…å«Dockerç›¸å…³ä¿¡æ¯
- `TaskSchedule` æ¨¡å‹ï¼šè°ƒåº¦é…ç½®

#### ä¼˜åŠ¿
1. **æ¨¡å‹é©±åŠ¨**: åŸºäºPythonæ¨¡å‹ï¼Œç±»å‹å®‰å…¨
2. **è‡ªåŠ¨åŒæ­¥**: æ¨¡å‹å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
3. **ç®€åŒ–ç»´æŠ¤**: æ— éœ€ç»´æŠ¤SQLè„šæœ¬
4. **å¼€å‘æ•ˆç‡**: æ›´å¿«çš„å¼€å‘å’Œè¿­ä»£é€Ÿåº¦

## æ€»ç»“

é€šè¿‡è¿™æ¬¡å®Œå…¨é‡æ„ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **ğŸ¯ æ¨¡å‹é©±åŠ¨**: åŸºäºSQLAlchemy ORMï¼Œæ¨¡å‹å³æ•°æ®åº“
2. **ğŸ“¦ é›¶SQLä¾èµ–**: å®Œå…¨ç§»é™¤SQLè„šæœ¬ï¼Œçº¯ORMæ–¹å¼
3. **ğŸ”§ è‡ªåŠ¨åŒæ­¥**: æ¨¡å‹å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
4. **ğŸš€ ç±»å‹å®‰å…¨**: åŸºäºPythonç±»å‹ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
5. **ğŸ’¡ å¼€å‘å‹å¥½**: æ›´ç›´è§‚çš„æ¨¡å‹å®šä¹‰å’Œæ“ä½œ
6. **ğŸ”„ ç®€åŒ–ç»´æŠ¤**: æ— éœ€ç»´æŠ¤å¤æ‚çš„SQLè„šæœ¬

ç°åœ¨çš„æ•°æ®åº“ç®¡ç†æ–¹æ¡ˆæ˜¯æœ€ç°ä»£åŒ–ã€æœ€å¼€å‘å‹å¥½çš„ç‰ˆæœ¬ï¼

## å‘½ä»¤é€ŸæŸ¥è¡¨

| æ“ä½œ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| åˆå§‹åŒ– | `pdm run db:init` | åŸºäºæ¨¡å‹åˆ›å»ºæ‰€æœ‰è¡¨ |
| å‡çº§ | `pdm run db:upgrade` | åŒæ­¥æ¨¡å‹å˜æ›´åˆ°æ•°æ®åº“ |
| çŠ¶æ€ | `pdm run db:status` | æŸ¥çœ‹æ•°æ®åº“å’Œè¡¨çŠ¶æ€ |
| é‡ç½® | `pdm run db:reset` | é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç”¨ï¼‰ |

## ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„](./é¡¹ç›®æ¶æ„.md) - äº†è§£æ•´ä½“æ¶æ„
- [å®‰è£…é…ç½®](./å®‰è£…é…ç½®.md) - ç¯å¢ƒé…ç½®æŒ‡å—
- [ä»»åŠ¡æ‰§è¡Œ](./ä»»åŠ¡æ‰§è¡Œ.md) - ä»»åŠ¡æ‰§è¡Œæµç¨‹