# æ•°æ®åº“ç®¡ç†æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ç®€åŒ–çš„æ•°æ®åº“ç®¡ç†æ–¹æ¡ˆï¼š**åŸºäºçº¯SQLè„šæœ¬ï¼Œæ— Alembicä¾èµ–**ã€‚æä¾›æ™ºèƒ½æ£€æµ‹ã€è‡ªåŠ¨å‡çº§ã€å®‰å…¨æ“ä½œç­‰åŠŸèƒ½ã€‚

## æ ¸å¿ƒç‰¹æ€§

### âœ¨ æ™ºèƒ½æ£€æµ‹
- è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“æ˜¯å¦å­˜åœ¨
- è‡ªåŠ¨æ£€æµ‹è¡¨ç»“æ„æ˜¯å¦å®Œæ•´
- è‡ªåŠ¨æ£€æµ‹å­—æ®µæ˜¯å¦éœ€è¦æ·»åŠ 
- æ™ºèƒ½é€‰æ‹©åˆå§‹åŒ–æˆ–å‡çº§æ“ä½œ

### ğŸ”’ å®‰å…¨æ“ä½œ
- é‡ç½®å‰éœ€è¦ç”¨æˆ·ç¡®è®¤
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
- æ“ä½œåè‡ªåŠ¨éªŒè¯ç»“æœ
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

### ğŸ“Š å®Œæ•´æ”¯æŒ
- æ”¯æŒå…¨æ–°å®‰è£…
- æ”¯æŒç°æœ‰ç³»ç»Ÿå‡çº§
- æ”¯æŒå­—æ®µç®¡ç†ï¼ˆå¦‚ `docker_container_id`ï¼‰
- æ”¯æŒç®¡ç†å‘˜ç”¨æˆ·åˆ›å»º

## ä½¿ç”¨æ–¹æ³•

### æ¨èå‘½ä»¤ï¼ˆPDMæ–¹å¼ï¼‰

```bash
# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå…¨æ–°å®‰è£…ï¼‰
pdm run db:init

# å‡çº§æ•°æ®åº“ï¼ˆç°æœ‰ç³»ç»Ÿï¼‰
pdm run db:upgrade

# æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
pdm run db:status

# é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
pdm run db:reset
```

### ç›´æ¥å‘½ä»¤æ–¹å¼

```bash
# ä½¿ç”¨ç»Ÿä¸€ç®¡ç†å·¥å…·
python scripts/db_manager.py init
python scripts/db_manager.py upgrade
python scripts/db_manager.py status
python scripts/db_manager.py reset

# æˆ–ä½¿ç”¨åŒ…è£…è„šæœ¬
python scripts/db_init.py
python scripts/db_upgrade.py
python scripts/db_status.py
python scripts/db_reset.py
```

## å­—æ®µç®¡ç†

### å®Œæ•´å­—æ®µæ”¯æŒ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `docker_container_name` | VARCHAR(64) | å®¹å™¨å | `task-12345678-1234-1234-1234-123456789abc` |
| `docker_container_id` | VARCHAR(64) | å®¹å™¨ID | `1905d7d88f85` |
| `docker_command` | TEXT | æ‰§è¡Œå‘½ä»¤ | `docker run -d --name task-123...` |
| `docker_port` | INT | ç«¯å£å· | `50001` |

### è‡ªåŠ¨å­—æ®µç®¡ç†

```python
# è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ ç¼ºå¤±å­—æ®µ
if not self.check_column_exists('task_executions', 'docker_container_id'):
    # è‡ªåŠ¨æ·»åŠ å­—æ®µå’Œç´¢å¼•
    self.add_docker_container_id_field()
```

## ä½¿ç”¨åœºæ™¯

### 1. å…¨æ–°å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository>
cd shyzj-docker-crawl-task-fastapi

# 2. å®‰è£…ä¾èµ–ï¼ˆä¸å†éœ€è¦Alembicï¼‰
pdm install

# 3. åˆå§‹åŒ–æ•°æ®åº“
pdm run db:init

# 4. å¯åŠ¨æœåŠ¡
pdm run dev:start
pdm run celery:all
```

### 2. ç°æœ‰ç³»ç»Ÿå‡çº§

```bash
# 1. æŸ¥çœ‹å½“å‰çŠ¶æ€
pdm run db:status

# 2. æ‰§è¡Œå‡çº§ï¼ˆè‡ªåŠ¨æ·»åŠ ç¼ºå¤±å­—æ®µï¼‰
pdm run db:upgrade

# 3. éªŒè¯å‡çº§ç»“æœ
pdm run db:status
```

### 3. å¼€å‘ç¯å¢ƒé‡ç½®

```bash
# é‡ç½®æ•°æ®åº“ï¼ˆä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦ç¡®è®¤ï¼‰
pdm run db:reset
```

### 4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p data_platform > backup.sql

# 2. æ‰§è¡Œå‡çº§
pdm run db:upgrade

# 3. éªŒè¯å‡çº§
pdm run db:status
```

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ç®€åŒ–æ¶æ„

- **å‡å°‘ä¾èµ–**: ç§»é™¤äº†Alembicï¼Œå‡å°‘äº†ä¸€ä¸ªå¤æ‚çš„ä¾èµ–
- **ç›´æ¥SQL**: ä½¿ç”¨çº¯SQLè„šæœ¬ï¼Œæ›´ç›´è§‚æ˜“æ‡‚
- **æ— è¿ç§»æ–‡ä»¶**: ä¸éœ€è¦ç»´æŠ¤å¤æ‚çš„è¿ç§»æ–‡ä»¶
- **ç¯å¢ƒé…ç½®**: æ”¯æŒä».envæ–‡ä»¶è¯»å–æ•°æ®åº“é…ç½®

### 2. æ€§èƒ½æå‡

- **æ›´å¿«å¯åŠ¨**: å‡å°‘äº†åˆå§‹åŒ–æ—¶é—´
- **æ›´å°‘å†…å­˜**: å‡å°‘äº†è¿è¡Œæ—¶å†…å­˜å ç”¨
- **æ›´å¿«å®‰è£…**: å‡å°‘äº†ä¾èµ–å®‰è£…æ—¶é—´

### 3. æ˜“äºç»´æŠ¤

- **ç›´è§‚æ˜“æ‡‚**: ç›´æ¥ä½¿ç”¨SQLï¼Œä¸éœ€è¦å­¦ä¹ è¿ç§»æœºåˆ¶
- **çµæ´»ä¿®æ”¹**: å¯ä»¥æ‰§è¡Œä»»æ„SQLè¯­å¥
- **ç®€å•è°ƒè¯•**: é—®é¢˜æ›´å®¹æ˜“å®šä½å’Œè§£å†³

### 4. å‘åå…¼å®¹

- **æ•°æ®å®‰å…¨**: ä¸ä¼šç ´åç°æœ‰æ•°æ®
- **å¹³æ»‘è¿ç§»**: æ”¯æŒä»Alembicç‰ˆæœ¬å¹³æ»‘è¿ç§»
- **æ—§å‘½ä»¤ä¿ç•™**: ä¿ç•™æ—§ç‰ˆå‘½ä»¤æ”¯æŒ

## å¯¹æ¯”åˆ†æ

### è¿ç§»å‰åå¯¹æ¯”

| æ–¹é¢ | è¿ç§»å‰ï¼ˆAlembicï¼‰ | è¿ç§»åï¼ˆç®€åŒ–ç‰ˆï¼‰ |
|------|------------------|------------------|
| ä¾èµ–æ•°é‡ | å¤šï¼ˆåŒ…å«Alembicï¼‰ | å°‘ï¼ˆç§»é™¤Alembicï¼‰ |
| å­¦ä¹ æˆæœ¬ | ä¸­ï¼ˆéœ€è¦å­¦ä¹ è¿ç§»ï¼‰ | ä½ï¼ˆç›´æ¥SQLï¼‰ |
| ç»´æŠ¤æˆæœ¬ | ä¸­ï¼ˆç»´æŠ¤è¿ç§»æ–‡ä»¶ï¼‰ | ä½ï¼ˆç»´æŠ¤SQLè„šæœ¬ï¼‰ |
| çµæ´»æ€§ | ä¸­ï¼ˆå—è¿ç§»é™åˆ¶ï¼‰ | é«˜ï¼ˆä»»æ„SQLï¼‰ |
| è°ƒè¯•éš¾åº¦ | ä¸­ï¼ˆè¿ç§»é—®é¢˜ï¼‰ | ä½ï¼ˆSQLé—®é¢˜ï¼‰ |
| å¯åŠ¨é€Ÿåº¦ | æ…¢ï¼ˆè¿ç§»æ£€æŸ¥ï¼‰ | å¿«ï¼ˆç›´æ¥æ‰§è¡Œï¼‰ |

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Alembicç‰ˆæœ¬ | ç®€åŒ–ç‰ˆæœ¬ |
|------|-------------|----------|
| æ•°æ®åº“åˆå§‹åŒ– | âœ… | âœ… |
| å­—æ®µæ·»åŠ  | âœ… | âœ… |
| è¡¨ç»“æ„å‡çº§ | âœ… | âœ… |
| æ•°æ®è¿ç§» | âœ… | âœ… |
| ç‰ˆæœ¬å›æ»š | âœ… | âŒ (å¯é€šè¿‡é‡ç½®å®ç°) |
| ä¾èµ–å¤æ‚åº¦ | é«˜ | ä½ |
| å­¦ä¹ æˆæœ¬ | ä¸­ | ä½ |
| ç»´æŠ¤æˆæœ¬ | ä¸­ | ä½ |

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MySQLè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
   sudo systemctl status mysql
   
   # å¯åŠ¨MySQLæœåŠ¡
   sudo systemctl start mysql
   ```

2. **æƒé™ä¸è¶³**
   ```bash
   # ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™
   mysql -u root -p -e "GRANT ALL PRIVILEGES ON data_platform.* TO 'root'@'localhost'; FLUSH PRIVILEGES;"
   ```

3. **å­—æ®µå·²å­˜åœ¨**
   ```bash
   # å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è·³è¿‡å·²å­˜åœ¨çš„å­—æ®µ
   pdm run db:status
   ```

### å›æ»šæ“ä½œ

å¦‚æœéœ€è¦å›æ»šåˆ°Alembicç‰ˆæœ¬ï¼š

```bash
# 1. æ¢å¤Alembicä¾èµ–
# åœ¨pyproject.tomlä¸­æ·»åŠ : "alembic>=1.13.0,<2.0.0"

# 2. é‡æ–°å®‰è£…ä¾èµ–
pdm install

# 3. ä½¿ç”¨æ—§ç‰ˆå‘½ä»¤
pdm run db:legacy-manager init
```

## æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ

- ä½¿ç”¨ `pdm run db:init` è¿›è¡Œåˆå§‹åŒ–
- ä½¿ç”¨ `pdm run db:status` æŸ¥çœ‹çŠ¶æ€
- ä½¿ç”¨ `pdm run db:reset` é‡ç½®ç¯å¢ƒ

### 2. ç”Ÿäº§ç¯å¢ƒ

- ä½¿ç”¨ `pdm run db:upgrade` è¿›è¡Œå‡çº§
- å‡çº§å‰å…ˆå¤‡ä»½æ•°æ®åº“
- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²

### 3. ç‰ˆæœ¬æ§åˆ¶

- æ‰€æœ‰æ•°æ®åº“å˜æ›´éƒ½é€šè¿‡SQLè„šæœ¬ç®¡ç†
- SQLè„šæœ¬éœ€è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- é¿å…ç›´æ¥ä¿®æ”¹æ•°æ®åº“ç»“æ„

## å­—æ®µå˜æ›´è®°å½•

### v2.0 (2025-09-24)

#### æ–°å¢å­—æ®µ
- `task_executions.docker_container_id`: VARCHAR(64) - Dockerå®¹å™¨ID

#### å­—æ®µè¯´æ˜
- `docker_container_name`: å®¹å™¨åï¼ˆå¦‚ `task-{execution_id}`ï¼‰
- `docker_container_id`: å®Œæ•´çš„å®¹å™¨IDï¼ˆå¦‚ `1905d7d88f85`ï¼‰

#### ä¼˜åŠ¿
1. **æ¶ˆé™¤æ­§ä¹‰**: æ˜ç¡®åŒºåˆ†å®¹å™¨åå’Œå®¹å™¨ID
2. **å®Œæ•´è¿½è¸ª**: åŒæ—¶ä¿å­˜ä¸¤ç§æ ‡è¯†ç¬¦
3. **ä¾¿äºè°ƒè¯•**: æ”¯æŒé€šè¿‡å®¹å™¨IDç›´æ¥æ“ä½œDocker
4. **å‘åå…¼å®¹**: ä¿æŒç°æœ‰å­—æ®µä¸å˜

## æ€»ç»“

é€šè¿‡è¿™æ¬¡å®Œå…¨é‡æ„ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **ğŸ¯ æœ€ç®€åŒ–æ¶æ„**: ç§»é™¤äº†Alembicï¼Œä½¿ç”¨çº¯SQLè„šæœ¬
2. **ğŸ“¦ æœ€å°‘ä¾èµ–**: å‡å°‘äº†é¡¹ç›®ä¾èµ–ï¼Œæé«˜å®‰è£…é€Ÿåº¦
3. **ğŸ”§ æœ€æ˜“ç»´æŠ¤**: ç›´æ¥ä½¿ç”¨SQLï¼Œæ›´å®¹æ˜“ç†è§£å’Œä¿®æ”¹
4. **ğŸš€ æœ€å¿«å¯åŠ¨**: å‡å°‘äº†åˆå§‹åŒ–æ—¶é—´
5. **ğŸ’¡ æœ€ç›´è§‚**: ä¸éœ€è¦å­¦ä¹ å¤æ‚çš„è¿ç§»æœºåˆ¶
6. **ğŸ”„ å‘åå…¼å®¹**: ä¿æŒå¯¹æ—§ç‰ˆæœ¬çš„æ”¯æŒ

ç°åœ¨çš„æ•°æ®åº“ç®¡ç†æ–¹æ¡ˆæ˜¯æœ€ç®€å•ã€æœ€ç›´æ¥ã€æœ€æ˜“ç»´æŠ¤çš„ç‰ˆæœ¬ï¼

## å‘½ä»¤é€ŸæŸ¥è¡¨

| æ“ä½œ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| åˆå§‹åŒ– | `pdm run db:init` | å…¨æ–°å®‰è£…æ•°æ®åº“ |
| å‡çº§ | `pdm run db:upgrade` | å‡çº§ç°æœ‰æ•°æ®åº“ |
| çŠ¶æ€ | `pdm run db:status` | æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€ |
| é‡ç½® | `pdm run db:reset` | é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç”¨ï¼‰ |
