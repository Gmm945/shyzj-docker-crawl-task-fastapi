# 数据库管理指南

## 概述

本项目使用简化的数据库管理方案：**基于纯SQL脚本，无Alembic依赖**。提供智能检测、自动升级、安全操作等功能。

## 核心特性

### ✨ 智能检测
- 自动检测数据库是否存在
- 自动检测表结构是否完整
- 自动检测字段是否需要添加
- 智能选择初始化或升级操作

### 🔒 安全操作
- 重置前需要用户确认
- 完善的错误处理和日志输出
- 操作后自动验证结果
- 失败时自动回滚

### 📊 完整支持
- 支持全新安装
- 支持现有系统升级
- 支持字段管理（如 `docker_container_id`）
- 支持管理员用户创建

## 使用方法

### 推荐命令（PDM方式）

```bash
# 初始化数据库（全新安装）
pdm run db:init

# 升级数据库（现有系统）
pdm run db:upgrade

# 查看数据库状态
pdm run db:status

# 重置数据库（开发环境）
pdm run db:reset
```

### 直接命令方式

```bash
# 使用统一管理工具
python scripts/db_manager.py init
python scripts/db_manager.py upgrade
python scripts/db_manager.py status
python scripts/db_manager.py reset

# 或使用包装脚本
python scripts/db_init.py
python scripts/db_upgrade.py
python scripts/db_status.py
python scripts/db_reset.py
```

## 字段管理

### 完整字段支持

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `docker_container_name` | VARCHAR(64) | 容器名 | `task-12345678-1234-1234-1234-123456789abc` |
| `docker_container_id` | VARCHAR(64) | 容器ID | `1905d7d88f85` |
| `docker_command` | TEXT | 执行命令 | `docker run -d --name task-123...` |
| `docker_port` | INT | 端口号 | `50001` |

### 自动字段管理

```python
# 自动检测并添加缺失字段
if not self.check_column_exists('task_executions', 'docker_container_id'):
    # 自动添加字段和索引
    self.add_docker_container_id_field()
```

## 使用场景

### 1. 全新安装

```bash
# 1. 克隆项目
git clone <repository>
cd shyzj-docker-crawl-task-fastapi

# 2. 安装依赖（不再需要Alembic）
pdm install

# 3. 初始化数据库
pdm run db:init

# 4. 启动服务
pdm run dev:start
pdm run celery:all
```

### 2. 现有系统升级

```bash
# 1. 查看当前状态
pdm run db:status

# 2. 执行升级（自动添加缺失字段）
pdm run db:upgrade

# 3. 验证升级结果
pdm run db:status
```

### 3. 开发环境重置

```bash
# 重置数据库（会删除所有数据，需要确认）
pdm run db:reset
```

### 4. 生产环境部署

```bash
# 1. 备份数据库
mysqldump -u root -p data_platform > backup.sql

# 2. 执行升级
pdm run db:upgrade

# 3. 验证升级
pdm run db:status
```

## 技术优势

### 1. 简化架构

- **减少依赖**: 移除了Alembic，减少了一个复杂的依赖
- **直接SQL**: 使用纯SQL脚本，更直观易懂
- **无迁移文件**: 不需要维护复杂的迁移文件
- **环境配置**: 支持从.env文件读取数据库配置

### 2. 性能提升

- **更快启动**: 减少了初始化时间
- **更少内存**: 减少了运行时内存占用
- **更快安装**: 减少了依赖安装时间

### 3. 易于维护

- **直观易懂**: 直接使用SQL，不需要学习迁移机制
- **灵活修改**: 可以执行任意SQL语句
- **简单调试**: 问题更容易定位和解决

### 4. 向后兼容

- **数据安全**: 不会破坏现有数据
- **平滑迁移**: 支持从Alembic版本平滑迁移
- **旧命令保留**: 保留旧版命令支持

## 对比分析

### 迁移前后对比

| 方面 | 迁移前（Alembic） | 迁移后（简化版） |
|------|------------------|------------------|
| 依赖数量 | 多（包含Alembic） | 少（移除Alembic） |
| 学习成本 | 中（需要学习迁移） | 低（直接SQL） |
| 维护成本 | 中（维护迁移文件） | 低（维护SQL脚本） |
| 灵活性 | 中（受迁移限制） | 高（任意SQL） |
| 调试难度 | 中（迁移问题） | 低（SQL问题） |
| 启动速度 | 慢（迁移检查） | 快（直接执行） |

### 功能对比

| 功能 | Alembic版本 | 简化版本 |
|------|-------------|----------|
| 数据库初始化 | ✅ | ✅ |
| 字段添加 | ✅ | ✅ |
| 表结构升级 | ✅ | ✅ |
| 数据迁移 | ✅ | ✅ |
| 版本回滚 | ✅ | ❌ (可通过重置实现) |
| 依赖复杂度 | 高 | 低 |
| 学习成本 | 中 | 低 |
| 维护成本 | 中 | 低 |

## 故障排除

### 常见问题

1. **MySQL连接失败**
   ```bash
   # 检查MySQL服务状态
   sudo systemctl status mysql
   
   # 启动MySQL服务
   sudo systemctl start mysql
   ```

2. **权限不足**
   ```bash
   # 确保用户有足够权限
   mysql -u root -p -e "GRANT ALL PRIVILEGES ON data_platform.* TO 'root'@'localhost'; FLUSH PRIVILEGES;"
   ```

3. **字段已存在**
   ```bash
   # 工具会自动检测并跳过已存在的字段
   pdm run db:status
   ```

### 回滚操作

如果需要回滚到Alembic版本：

```bash
# 1. 恢复Alembic依赖
# 在pyproject.toml中添加: "alembic>=1.13.0,<2.0.0"

# 2. 重新安装依赖
pdm install

# 3. 使用旧版命令
pdm run db:legacy-manager init
```

## 最佳实践

### 1. 开发环境

- 使用 `pdm run db:init` 进行初始化
- 使用 `pdm run db:status` 查看状态
- 使用 `pdm run db:reset` 重置环境

### 2. 生产环境

- 使用 `pdm run db:upgrade` 进行升级
- 升级前先备份数据库
- 在测试环境验证后再部署

### 3. 版本控制

- 所有数据库变更都通过SQL脚本管理
- SQL脚本需要提交到版本控制
- 避免直接修改数据库结构

## 字段变更记录

### v2.0 (2025-09-24)

#### 新增字段
- `task_executions.docker_container_id`: VARCHAR(64) - Docker容器ID

#### 字段说明
- `docker_container_name`: 容器名（如 `task-{execution_id}`）
- `docker_container_id`: 完整的容器ID（如 `1905d7d88f85`）

#### 优势
1. **消除歧义**: 明确区分容器名和容器ID
2. **完整追踪**: 同时保存两种标识符
3. **便于调试**: 支持通过容器ID直接操作Docker
4. **向后兼容**: 保持现有字段不变

## 总结

通过这次完全重构，我们实现了：

1. **🎯 最简化架构**: 移除了Alembic，使用纯SQL脚本
2. **📦 最少依赖**: 减少了项目依赖，提高安装速度
3. **🔧 最易维护**: 直接使用SQL，更容易理解和修改
4. **🚀 最快启动**: 减少了初始化时间
5. **💡 最直观**: 不需要学习复杂的迁移机制
6. **🔄 向后兼容**: 保持对旧版本的支持

现在的数据库管理方案是最简单、最直接、最易维护的版本！

## 命令速查表

| 操作 | 命令 | 说明 |
|------|------|------|
| 初始化 | `pdm run db:init` | 全新安装数据库 |
| 升级 | `pdm run db:upgrade` | 升级现有数据库 |
| 状态 | `pdm run db:status` | 查看数据库状态 |
| 重置 | `pdm run db:reset` | 重置数据库（开发用） |
