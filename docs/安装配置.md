# 安装配置指南

## 环境要求

- **Python**: 3.12 或更高版本
- **MySQL**: 5.7 或更高版本
- **Redis**: 5.0 或更高版本
- **PDM**: 现代化的 Python 依赖管理工具
- **Docker**: 容器化任务执行支持

## 快速安装

### 1. 克隆项目
```bash
git clone <repository-url>
cd shyzj-docker-crawl-task-fastapi
```

### 2. 安装 PDM
```bash
# 使用 pip 安装
pip install pdm

# 或使用官方安装脚本
curl -sSL https://raw.githubusercontent.com/pdm-project/pdm/main/install-pdm.py | python -
```

### 3. 安装依赖
```bash
pdm install
```

### 4. 配置环境变量
```bash
# 复制配置文件
cp .env.example .env

# 编辑配置文件
nano .env
```

### 5. 初始化数据库
```bash
pdm run db:reset
pdm run db:init_perm
```

### 6. 启动服务
```bash
# 启动 API 服务
pdm run start

# 启动所有 Celery 服务 (新终端)
pdm run celery:all
```

## 环境变量配置

### 数据库配置
```bash
MYSQL_HOST=localhost          # MySQL服务器地址
MYSQL_PORT=3306              # MySQL端口
MYSQL_USER=root              # 数据库用户名
MYSQL_PASSWORD=123456        # 数据库密码
MYSQL_DATABASE=data_platform # 数据库名称
```

### Redis配置
```bash
REDIS_HOST=localhost         # Redis服务器地址
REDIS_PORT=6379             # Redis端口
REDIS_PASSWORD=             # Redis密码（可选）
REDIS_DB=0                  # Redis数据库编号
```

### 应用配置
```bash
SECRET_KEY=your-secret-key   # JWT密钥（生产环境必须修改）
ADMIN_PASSWORD=admin123      # 管理员默认密码
DEBUG=true                   # 调试模式
LOG_LEVEL=INFO              # 日志级别
API_PORT=8000               # API服务端口
```

### Docker配置
```bash
DOCKER_HOST_IP=127.0.0.1    # Docker主机IP
DOCKER_HOST=                 # Docker守护进程地址（可选）
DOCKER_AUTO_REMOVE=false    # 容器自动删除
DOCKER_REMOVE_ON_STOP=false # 停止时删除容器
```

### Celery配置
```bash
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

## 服务配置

### MySQL服务
```bash
# Ubuntu/Debian
sudo systemctl start mysql

# macOS (使用Homebrew)
brew services start mysql

# Docker
docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:8.0
```

### Redis服务
```bash
# Ubuntu/Debian
sudo systemctl start redis-server

# macOS (使用Homebrew)
brew services start redis

# Docker
docker run -d -p 6379:6379 redis:alpine
```

### Docker服务
```bash
# Ubuntu/Debian
sudo systemctl start docker

# macOS
# Docker Desktop 会自动启动

# 验证Docker
docker --version
docker info
```

## 开发环境

### 开发工具
```bash
# 格式化代码
pdm run format

# 代码检查
pdm run lint

# 类型检查
pdm run type-check

# 运行测试
pdm run test
```

### 服务启动
```bash
# 启动开发服务器
pdm run start

# 启动所有Celery服务
pdm run celery:all
```

## 生产环境

### 环境变量
```bash
# 生产环境配置
DEBUG=false
LOG_LEVEL=WARNING
SECRET_KEY=your-production-secret-key
ADMIN_PASSWORD=your-secure-password
```

### 进程管理
```bash
# 使用 systemd 管理服务
sudo systemctl enable your-app
sudo systemctl start your-app

# 使用 supervisor 管理进程
supervisorctl start all
```

## 故障排除

### 常见问题
1. **MySQL连接失败** - 检查服务状态和配置
2. **Redis连接失败** - 验证Redis服务运行
3. **Docker任务失败** - 检查镜像和网络配置
4. **权限错误** - 检查用户权限和角色配置

### 日志查看
```bash
# 查看应用日志
tail -f logs/app.log

# 查看Celery日志
tail -f logs/celery.log

# 查看系统日志
journalctl -u your-app -f
```

## 安全配置

### 数据库安全
- 使用专用的数据库用户
- 设置强密码
- 配置适当的权限
- 启用SSL连接

### Redis安全
- 设置密码认证
- 配置持久化
- 设置内存限制
- 启用安全模式

## 监控和维护

### 日志管理
```bash
# 查看应用日志
tail -f logs/app.log

# 查看Celery日志
tail -f logs/celery.log

# 查看系统日志
journalctl -u your-app -f
```

### 性能监控
```bash
# 查看系统资源使用
htop

# 查看数据库连接
mysqladmin processlist

# 查看Redis内存使用
redis-cli info memory
```
```

## 总结

本指南涵盖了数据采集任务管理系统的完整安装和配置流程。通过遵循这些步骤，您可以成功部署和运行系统。

更多详细信息请参考：
- [README](README.md) - 项目概述和快速开始
- [API使用指南](API使用指南.md) - API接口使用说明
