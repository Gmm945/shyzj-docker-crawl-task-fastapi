# 安装配置指南

## 环境要求

- **Python**: 3.8 或更高版本
- **MySQL**: 5.7 或更高版本
- **Redis**: 5.0 或更高版本
- **PDM**: 现代化的 Python 依赖管理工具

## 快速安装

### 1. 克隆项目
```bash
git clone <repository-url>
cd data_plat_project
```

### 2. 安装 PDM
```bash
# 使用 pip 安装
pip install pdm

# 或使用官方安装脚本
curl -sSL https://raw.githubusercontent.com/pdm-project/pdm/main/install-pdm.py | python -
```

### 3. 安装依赖
```bash
pdm install
```

### 4. 配置环境变量
```bash
# 复制配置文件
cp .env.example .env

# 编辑配置文件
nano .env
```

### 5. 初始化数据库
```bash
pdm run db-upgrade
```

### 6. 启动服务
```bash
# 启动 API 服务
pdm run start

# 启动 Worker (新终端)
pdm run worker

# 启动调度器 (新终端)
pdm run beat
```

## 详细配置

### 环境变量配置

#### 数据库配置
```bash
MYSQL_HOST=localhost          # MySQL服务器地址
MYSQL_PORT=3306              # MySQL端口
MYSQL_USER=app_user          # 数据库用户名
MYSQL_PASSWORD=app_password  # 数据库密码
MYSQL_DATABASE=data_platform # 数据库名称
```

#### Redis配置
```bash
REDIS_HOST=localhost         # Redis服务器地址
REDIS_PORT=6379             # Redis端口
REDIS_PASSWORD=             # Redis密码（可选）
REDIS_DB=0                  # Redis数据库编号
```

#### 应用配置
```bash
SECRET_KEY=your-secret-key   # JWT密钥（生产环境必须修改）
ADMIN_PASSWORD=admin123      # 管理员默认密码
DEBUG=true                   # 调试模式
LOG_LEVEL=INFO              # 日志级别
```

#### Celery配置
```bash
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

### 配置文件说明

项目提供了多个配置文件模板：

- `.env` - 默认配置模板（包含详细说明）
- `.env.local` - 本地开发环境配置
- `.env.production` - 生产环境配置（需要手动创建）

### 数据库配置

#### 创建数据库
```sql
CREATE DATABASE data_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'app_password';
GRANT ALL PRIVILEGES ON data_platform.* TO 'app_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 数据库迁移
```bash
# 创建迁移文件
pdm run db-revision "描述信息"

# 执行迁移
pdm run db-upgrade

# 查看迁移历史
pdm run db-history

# 查看当前版本
pdm run db-current
```

### Redis配置

#### 启动Redis服务
```bash
# Ubuntu/Debian
sudo systemctl start redis-server

# macOS (使用Homebrew)
brew services start redis

# Docker
docker run -d -p 6379:6379 redis:alpine
```

#### 验证Redis连接
```bash
redis-cli ping
# 应该返回 PONG
```

## 开发环境

### 代码格式化
```bash
# 格式化代码
pdm run format

# 代码检查
pdm run lint

# 类型检查
pdm run mypy
```

### 运行测试
```bash
# 运行所有测试
pdm run test

# 运行特定测试
pytest tests/test_specific.py
```

### 数据库操作
```bash
# 创建新的迁移
pdm run db-revision "add new table"

# 应用迁移
pdm run db-upgrade

# 回滚迁移
pdm run db-downgrade
```

## 生产环境

### 环境变量
```bash
# 生产环境配置
DEBUG=false
LOG_LEVEL=WARNING
SECRET_KEY=your-production-secret-key
ADMIN_PASSWORD=your-secure-password
```

### 数据库配置
- 使用专用的数据库用户
- 设置强密码
- 配置适当的权限
- 启用SSL连接

### Redis配置
- 设置密码认证
- 配置持久化
- 设置内存限制
- 启用安全模式

### 服务启动
```bash
# 使用 systemd 管理服务
sudo systemctl start data-platform-api
sudo systemctl start data-platform-worker
sudo systemctl start data-platform-beat
```

## 故障排除

### 常见问题

#### 1. 数据库连接失败
```bash
# 检查数据库服务状态
sudo systemctl status mysql

# 检查连接配置
mysql -h localhost -u app_user -p data_platform
```

#### 2. Redis连接失败
```bash
# 检查Redis服务状态
sudo systemctl status redis

# 测试连接
redis-cli ping
```

#### 3. 依赖安装失败
```bash
# 清理缓存
pdm cache clear

# 重新安装
pdm install --force
```

#### 4. 端口占用
```bash
# 查看端口占用
lsof -i :8000
lsof -i :6379
lsof -i :3306

# 杀死进程
kill -9 <PID>
```

### 日志查看
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
tail -f logs/error.log

# 查看Celery日志
tail -f logs/celery.log
```

## 性能优化

### 数据库优化
- 创建适当的索引
- 配置连接池
- 定期清理旧数据
- 监控慢查询

### Redis优化
- 配置内存限制
- 启用持久化
- 监控内存使用
- 定期清理过期键

### 应用优化
- 启用Gzip压缩
- 配置静态文件缓存
- 使用CDN加速
- 监控性能指标

## 安全建议

### 生产环境安全
- 使用强密码
- 启用HTTPS
- 配置防火墙
- 定期更新依赖
- 监控安全日志

### 数据安全
- 定期备份数据库
- 加密敏感数据
- 限制数据库访问
- 审计数据访问

## 监控和维护

### 健康检查
```bash
# API健康检查
curl http://localhost:8000/health

# 数据库健康检查
pdm run db-current

# Redis健康检查
redis-cli ping
```

### 备份策略
```bash
# 数据库备份
mysqldump -u app_user -p data_platform > backup.sql

# 恢复数据库
mysql -u app_user -p data_platform < backup.sql
```

### 日志轮转
```bash
# 配置logrotate
sudo nano /etc/logrotate.d/data-platform
```

## 总结

通过本指南，您可以：

1. **快速启动** - 在几分钟内启动项目
2. **正确配置** - 了解所有配置选项
3. **开发调试** - 掌握开发工具和流程
4. **生产部署** - 安全地部署到生产环境
5. **故障排除** - 解决常见问题
6. **性能优化** - 提升系统性能
7. **安全维护** - 确保系统安全

如有问题，请查看项目文档或提交Issue。
