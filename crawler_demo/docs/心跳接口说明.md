# 心跳接口说明

## 概述

爬虫容器需要定期向主控系统发送心跳，报告任务执行状态和进度。本文档详细说明了心跳接口的使用方法。

## 接口地址

```
POST {API_BASE_URL}/api/v1/monitoring/heartbeat
```

其中 `API_BASE_URL` 是主控系统的API基础地址，通过环境变量 `API_BASE_URL` 设置。

## 请求格式

### 请求头
```http
Content-Type: application/json
```

### 请求体
```json
{
  "execution_id": "550e8400-e29b-41d4-a716-446655440000",
  "container_id": "crawler-container-abc123",
  "status": "running",
  "progress": {
    "total_urls": 100,
    "crawled_urls": 45,
    "successful_urls": 42,
    "failed_urls": 3,
    "current_url": "https://example.com/page45",
    "current_stage": "爬取中 (45/100)",
    "data_items": 1250,
    "percentage": 45.0,
    "runtime_seconds": 1800,
    "start_time": "2024-01-01T10:00:00",
    "error_count": 0
  },
  "timestamp": 1640995200
}
```

### 字段说明

#### 必需字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `execution_id` | string | 任务执行ID，UUID格式 |
| `container_id` | string | 容器ID，通常是HOSTNAME |
| `timestamp` | integer | 客户端时间戳（Unix时间戳） |

#### 可选字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `status` | string | 任务状态：`running`、`completed`、`failed` |
| `progress` | object | 详细进度信息 |

#### 进度字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `total_urls` | integer | 总URL数量 |
| `crawled_urls` | integer | 已爬取URL数量 |
| `successful_urls` | integer | 成功爬取URL数量 |
| `failed_urls` | integer | 失败URL数量 |
| `current_url` | string | 当前正在爬取的URL |
| `current_stage` | string | 当前阶段描述 |
| `data_items` | integer | 已提取的数据条目数 |
| `percentage` | number | 完成百分比（0-100） |
| `runtime_seconds` | number | 运行时间（秒） |
| `start_time` | string | 开始时间（ISO格式） |
| `error_count` | integer | 错误次数 |

## 响应格式

### 成功响应
```json
{
  "status": "ok",
  "timestamp": 1640995200,
  "execution_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 错误响应
```json
{
  "status": "error",
  "message": "Invalid execution_id format"
}
```

## 发送频率

- **建议频率**: 每30秒发送一次
- **最小频率**: 每60秒发送一次
- **最大频率**: 每10秒发送一次

## 实现示例

### Python实现

```python
import requests
import time
import json
from datetime import datetime

class HeartbeatClient:
    def __init__(self, api_base_url, execution_id, container_id):
        self.api_base_url = api_base_url.rstrip('/')
        self.execution_id = execution_id
        self.container_id = container_id
        self.heartbeat_url = f"{self.api_base_url}/api/v1/monitoring/heartbeat"
    
    def send_heartbeat(self, status="running", progress=None):
        """发送心跳"""
        try:
            heartbeat_data = {
                "execution_id": self.execution_id,
                "container_id": self.container_id,
                "status": status,
                "progress": progress or {},
                "timestamp": int(time.time())
            }
            
            response = requests.post(
                self.heartbeat_url,
                json=heartbeat_data,
                timeout=10,
                headers={'Content-Type': 'application/json'}
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get('status') == 'ok':
                    print(f"心跳发送成功: {progress.get('percentage', 0):.1f}%")
                else:
                    print(f"心跳响应异常: {result}")
            else:
                print(f"心跳请求失败: {response.status_code}")
                
        except Exception as e:
            print(f"心跳发送异常: {e}")

# 使用示例
heartbeat_client = HeartbeatClient(
    api_base_url="http://data-platform-api:8000",
    execution_id="550e8400-e29b-41d4-a716-446655440000",
    container_id="crawler-container"
)

# 发送心跳
progress = {
    "total_urls": 100,
    "crawled_urls": 45,
    "successful_urls": 42,
    "failed_urls": 3,
    "current_url": "https://example.com/page45",
    "current_stage": "爬取中 (45/100)",
    "data_items": 1250,
    "percentage": 45.0,
    "runtime_seconds": 1800
}

heartbeat_client.send_heartbeat(status="running", progress=progress)
```

### curl示例

```bash
curl -X POST http://data-platform-api:8000/api/v1/monitoring/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "execution_id": "550e8400-e29b-41d4-a716-446655440000",
    "container_id": "crawler-container",
    "status": "running",
    "progress": {
      "total_urls": 100,
      "crawled_urls": 45,
      "successful_urls": 42,
      "failed_urls": 3,
      "current_url": "https://example.com/page45",
      "current_stage": "爬取中 (45/100)",
      "data_items": 1250,
      "percentage": 45.0,
      "runtime_seconds": 1800
    },
    "timestamp": 1640995200
  }'
```

## 错误处理

### 网络错误
- 网络超时或连接失败时，记录错误但不中断任务
- 可以重试发送，但不要过于频繁

### 服务器错误
- 4xx错误：检查请求格式和参数
- 5xx错误：服务器内部错误，记录并继续

### 超时处理
- 设置合理的超时时间（建议10秒）
- 超时后不重试，等待下次心跳

## 最佳实践

### 1. 异步发送
```python
import threading
import time

def heartbeat_loop():
    while running:
        send_heartbeat()
        time.sleep(30)

# 在独立线程中运行心跳
heartbeat_thread = threading.Thread(target=heartbeat_loop, daemon=True)
heartbeat_thread.start()
```

### 2. 错误重试
```python
import time
from functools import wraps

def retry_on_failure(max_retries=3, delay=5):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_retries - 1:
                        print(f"心跳发送失败，已重试{max_retries}次: {e}")
                        break
                    time.sleep(delay)
            return None
        return wrapper
    return decorator

@retry_on_failure(max_retries=3, delay=5)
def send_heartbeat():
    # 心跳发送逻辑
    pass
```

### 3. 进度计算
```python
def calculate_progress(total_urls, crawled_urls):
    """计算进度百分比"""
    if total_urls == 0:
        return 0.0
    return round(crawled_urls / total_urls * 100, 2)

def get_runtime_seconds(start_time):
    """计算运行时间"""
    return (datetime.now() - start_time).total_seconds()
```

### 4. 状态管理
```python
class TaskStatus:
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    PAUSED = "paused"

# 根据任务状态发送不同信息
if task.is_completed:
    status = TaskStatus.COMPLETED
elif task.has_error:
    status = TaskStatus.FAILED
else:
    status = TaskStatus.RUNNING
```

## 监控和调试

### 日志记录
```python
import logging

logger = logging.getLogger(__name__)

def send_heartbeat(self, progress):
    try:
        # 发送心跳
        response = requests.post(...)
        logger.debug(f"心跳发送成功: {progress['percentage']:.1f}%")
    except Exception as e:
        logger.error(f"心跳发送失败: {e}")
```

### 调试模式
```python
import os

DEBUG = os.getenv('DEBUG', 'false').lower() == 'true'

def send_heartbeat(self, progress):
    if DEBUG:
        print(f"发送心跳: {json.dumps(progress, indent=2)}")
    # 正常发送逻辑
```

## 注意事项

1. **时间戳同步**: 使用客户端时间戳，服务端会计算网络延迟
2. **进度准确性**: 确保进度信息准确，避免误导
3. **错误处理**: 心跳失败不应影响主任务执行
4. **资源使用**: 避免过于频繁的心跳请求
5. **数据大小**: 进度数据不要过大，避免网络传输问题
